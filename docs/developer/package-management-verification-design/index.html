<!DOCTYPE html><html lang="en" data-theme="light" class="transition-colors duration-200"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/ghostty-config-files/favicon.svg"><meta name="generator" content="Astro v5.15.9"><title>Package Management Verification and Migration Strategy | Ghostty Configuration Files</title><meta name="description" content="**Document Version**: 1.0"><!-- OpenGraph --><meta property="og:title" content="Package Management Verification and Migration Strategy"><meta property="og:description" content="**Document Version**: 1.0"><meta property="og:type" content="website"><!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/ghostty-config-files/_astro/_slug_.zlehmsn5.css"></head> <body class="min-h-screen bg-white dark:bg-slate-900 text-gray-900 dark:text-gray-100 transition-colors duration-200 cyber-bg"> <!-- Modern Glass Morphism Navigation --> <nav class="fixed top-0 w-full backdrop-blur-xl bg-white/80 dark:bg-slate-900/80 shadow-lg border-b border-gray-200/50 dark:border-gray-700/50 z-50 transition-all duration-300"> <div class="full-width-section"> <div class="navbar"> <div class="flex-1"> <a href="/ghostty-config-files/" class="btn btn-ghost text-xl font-bold hover:text-blue-600 dark:hover:text-cyan-400 transition-all"> <span class="hidden md:inline">Ghostty Config Files</span> <span class="md:hidden">Ghostty</span> </a> </div> <div class="flex-none gap-2"> <ul class="menu menu-horizontal px-1 hidden lg:flex gap-4"> <li><a href="/ghostty-config-files/user-guide" class="nav-link">User Guide</a></li> <li><a href="/ghostty-config-files/ai-guidelines" class="nav-link">AI Guidelines</a></li> <li><a href="/ghostty-config-files/developer" class="nav-link">Developer</a></li> <li> <a href="https://github.com/kairin/ghostty-config-files" target="_blank" rel="noopener noreferrer" class="nav-link">
GitHub
</a> </li> </ul> <button id="theme-toggle" class="btn btn-ghost btn-circle" aria-label="Toggle theme" title="Toggle dark/light mode" data-astro-cid-x3pjskd3> <svg id="theme-icon-sun" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-x3pjskd3> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" data-astro-cid-x3pjskd3></path> </svg> <svg id="theme-icon-moon" class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-x3pjskd3> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" data-astro-cid-x3pjskd3></path> </svg> </button> <script type="module">function c(){const e=document.documentElement,t=document.getElementById("theme-icon-sun"),n=document.getElementById("theme-icon-moon"),d=localStorage.getItem("theme"),s=window.matchMedia("(prefers-color-scheme: dark)").matches,o=d||(s?"dark":"light");o==="dark"?(e.setAttribute("data-theme","dark"),e.classList.add("dark"),t&&t.classList.remove("hidden"),n&&n.classList.add("hidden")):(e.setAttribute("data-theme","light"),e.classList.remove("dark"),t&&t.classList.add("hidden"),n&&n.classList.remove("hidden")),localStorage.setItem("theme",o)}function a(){const e=document.documentElement,t=document.getElementById("theme-icon-sun"),n=document.getElementById("theme-icon-moon"),s=e.getAttribute("data-theme")==="dark"?"light":"dark";e.setAttribute("data-theme",s),s==="dark"?(e.classList.add("dark"),t&&t.classList.remove("hidden"),n&&n.classList.add("hidden")):(e.classList.remove("dark"),t&&t.classList.add("hidden"),n&&n.classList.remove("hidden")),localStorage.setItem("theme",s)}c();const m=document.getElementById("theme-toggle");m&&m.addEventListener("click",a);document.addEventListener("astro:page-load",c);</script>  </div> </div> </div> </nav> <!-- Spacer for fixed nav --> <div class="h-20"></div> <!-- Main Content - Full Width --> <main class="w-full px-4 md:px-8 lg:px-12 xl:px-16 py-12"> <!-- Article Header (if metadata provided) --> <div class="mb-8 text-sm text-gray-600 dark:text-gray-400"> <time datetime="2025-11-25T00:00:00.000Z"> November 25, 2025 </time> <span> by Ghostty Config Team</span> </div> <!-- Page Content - Full Width with Max Readable for Prose --> <article class="prose prose-lg w-full max-w-none text-lg leading-relaxed">  <div class="breadcrumbs text-sm mb-6"> <ul> <li><a href="/ghostty-config-files/">Home</a></li> <li><a href="/ghostty-config-files/developer/architecture">Developer</a></li> <li>Package Management Verification and Migration Strategy</li> </ul> </div> <h1>Package Management Verification and Migration Strategy</h1> <p class="text-xl text-base-content/70 mb-8">**Document Version**: 1.0</p><h1 id="package-management-verification-and-migration-strategy">Package Management Verification and Migration Strategy</h1>
<p><strong>Document Version</strong>: 1.0
<strong>Date</strong>: 2025-11-17
<strong>Status</strong>: Design Document - Research Phase
<strong>Target System</strong>: Ubuntu 25.10 (Questing Quokka)</p>
<hr>
<h2 id="executive-summary">Executive Summary</h2>
<p>This document defines a systematic, audit-ready approach to package management verification and migration for the ghostty-config-files repository. The design prioritizes <strong>real-time system queries</strong> over hardcoded assumptions, ensuring decisions are based on actual package availability, versions, and system state.</p>
<p><strong>Core Principles</strong>:</p>
<ol>
<li><strong>No Hardcoded Assumptions</strong>: Always query apt/snap/dpkg in real-time</li>
<li><strong>Transparent Decision Making</strong>: Log all checks, comparisons, and decisions</li>
<li><strong>Safe Migration</strong>: Complete removal tracking with rollback capability</li>
<li><strong>Audit-Ready</strong>: Before/after state snapshots for every operation</li>
<li><strong>Constitutional Compliance</strong>: Follows repository’s zero-cost local CI/CD requirements</li>
</ol>
<hr>
<h2 id="1-real-time-verification-method">1. Real-Time Verification Method</h2>
<h3 id="11-package-information-query-system">1.1 Package Information Query System</h3>
<h4 id="design-overview">Design Overview</h4>
<p>A modular query system that retrieves actual package information from multiple sources without assumptions.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Core Query Functions (pseudocode)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">query_apt_package_info</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Query apt cache for package availability and versions</span></span>
<span class="line"><span style="color:#E1E4E8">    apt_available</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">apt-cache</span><span style="color:#9ECBFF"> policy</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-z</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$apt_available</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">            available:</span><span style="color:#79B8FF"> false</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#79B8FF">            source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "apt",</span></span>
<span class="line"><span style="color:#B392F0">            timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Extract structured information</span></span>
<span class="line"><span style="color:#E1E4E8">    installed_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$apt_available</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "Installed:"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    candidate_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$apt_available</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "Candidate:"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if available in multiple repos</span></span>
<span class="line"><span style="color:#E1E4E8">    available_versions</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">apt-cache</span><span style="color:#9ECBFF"> madison</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                        awk</span><span style="color:#9ECBFF"> '{print $3}'</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> sort</span><span style="color:#79B8FF"> -V</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">        available:</span><span style="color:#79B8FF"> true</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#79B8FF">        source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "apt",</span></span>
<span class="line"><span style="color:#B392F0">        installed:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installed_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        candidate:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$candidate_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        all_versions:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$available_versions</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        repository_info:</span><span style="color:#9ECBFF"> "$(</span><span style="color:#B392F0">apt-cache</span><span style="color:#9ECBFF"> policy "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">" </span><span style="color:#F97583">|</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -A1</span><span style="color:#9ECBFF"> Candidate)",</span></span>
<span class="line"><span style="color:#B392F0">        timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">query_snap_package_info</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if snapd is available and active</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> snap</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">            available:</span><span style="color:#79B8FF"> false</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#79B8FF">            source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "snap",</span></span>
<span class="line"><span style="color:#B392F0">            error:</span><span style="color:#9ECBFF"> "snapd_not_installed",</span></span>
<span class="line"><span style="color:#B392F0">            timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> systemctl</span><span style="color:#9ECBFF"> is-active</span><span style="color:#79B8FF"> --quiet</span><span style="color:#9ECBFF"> snapd.service</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">            available:</span><span style="color:#79B8FF"> false</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#79B8FF">            source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "snap",</span></span>
<span class="line"><span style="color:#B392F0">            error:</span><span style="color:#9ECBFF"> "snapd_not_active",</span></span>
<span class="line"><span style="color:#B392F0">            timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Query snap store</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">snap</span><span style="color:#9ECBFF"> info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_query_status</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ $snap_query_status </span><span style="color:#F97583">-ne</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">            available:</span><span style="color:#79B8FF"> false</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#79B8FF">            source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "snap",</span></span>
<span class="line"><span style="color:#B392F0">            error:</span><span style="color:#9ECBFF"> "package_not_found",</span></span>
<span class="line"><span style="color:#B392F0">            timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Extract structured information</span></span>
<span class="line"><span style="color:#E1E4E8">    installed_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> tail</span><span style="color:#79B8FF"> -1</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    stable_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "latest/stable:"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    publisher</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "publisher:"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2, $3}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    publisher_verified</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$publisher</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "✓"</span><span style="color:#E1E4E8"> &#x26;&#x26; </span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "true"</span><span style="color:#F97583"> ||</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> "false"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    confinement</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "confinement:"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Get all available channels</span></span>
<span class="line"><span style="color:#E1E4E8">    channels</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -E</span><span style="color:#9ECBFF"> "(stable|candidate|beta|edge):"</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">               awk</span><span style="color:#9ECBFF"> '{print $1 "=" $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">        available:</span><span style="color:#79B8FF"> true</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#79B8FF">        source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "snap",</span></span>
<span class="line"><span style="color:#B392F0">        installed:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installed_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        stable_version:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$stable_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        publisher:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$publisher</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        publisher_verified:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$publisher_verified</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        confinement:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$confinement</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        channels:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$channels</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">query_current_installation</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    binary_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">${2</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">$package_name</span><span style="color:#FFAB70">}</span><span style="color:#6A737D">  # Allow different binary name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if command exists</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">            installed:</span><span style="color:#79B8FF"> false</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#B392F0">            timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Determine installation source</span></span>
<span class="line"><span style="color:#E1E4E8">    binary_path</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    installation_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"unknown"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check dpkg database</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#B392F0"> dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -qE</span><span style="color:#9ECBFF"> "^ii\s+</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">\s"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">        installation_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"apt"</span></span>
<span class="line"><span style="color:#E1E4E8">        dpkg_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "^ii.*</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        installed_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$dpkg_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $3}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check snap database</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#B392F0"> snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "^</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">        installation_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"snap"</span></span>
<span class="line"><span style="color:#E1E4E8">        installed_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> tail</span><span style="color:#79B8FF"> -1</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Get version from binary if available</span></span>
<span class="line"><span style="color:#E1E4E8">    binary_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_version_from_binary</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#B392F0">        installed:</span><span style="color:#79B8FF"> true</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#B392F0">        binary_path:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_path</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        installation_source:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        installed_version:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installed_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        binary_version:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">        timestamp:</span><span style="color:#E1E4E8"> $(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">get_version_from_binary</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    binary_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Try common version flags</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> flag </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "--version"</span><span style="color:#9ECBFF"> "-v"</span><span style="color:#9ECBFF"> "version"</span><span style="color:#9ECBFF"> "-V"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#E1E4E8">        version_output</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">"</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#B392F0">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$flag</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> head</span><span style="color:#79B8FF"> -1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#79B8FF">$?</span><span style="color:#F97583"> -eq</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#6A737D">            # Extract version number (flexible pattern matching)</span></span>
<span class="line"><span style="color:#E1E4E8">            version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version_output</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                     grep</span><span style="color:#79B8FF"> -oP</span><span style="color:#9ECBFF"> '(\d+\.)+\d+(-[\w.]+)?'</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> head</span><span style="color:#79B8FF"> -1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-n</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">                echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "unknown"</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="12-version-comparison-logic">1.2 Version Comparison Logic</h3>
<h4 id="design-overview-1">Design Overview</h4>
<p>Use system-native version comparison tools for accuracy across different versioning schemes.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">compare_versions</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    version1</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    operator</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span><span style="color:#6A737D">  # gt, ge, lt, le, eq, ne</span></span>
<span class="line"><span style="color:#E1E4E8">    version2</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Log comparison attempt</span></span>
<span class="line"><span style="color:#B392F0">    log_comparison</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version1</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$operator</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version2</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Handle special cases</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version1</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "none"</span><span style="color:#E1E4E8"> ]] </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version1</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "(none)"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$operator</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#9ECBFF">            "gt"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"ge"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"eq"</span><span style="color:#F97583">)</span><span style="color:#F97583"> return</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> ;;</span></span>
<span class="line"><span style="color:#9ECBFF">            "lt"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"le"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"ne"</span><span style="color:#F97583">)</span><span style="color:#F97583"> return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> ;;</span></span>
<span class="line"><span style="color:#F97583">        esac</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version2</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "none"</span><span style="color:#E1E4E8"> ]] </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version2</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "(none)"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$operator</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#9ECBFF">            "gt"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"ge"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"ne"</span><span style="color:#F97583">)</span><span style="color:#F97583"> return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> ;;</span></span>
<span class="line"><span style="color:#9ECBFF">            "lt"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"le"</span><span style="color:#F97583">|</span><span style="color:#9ECBFF">"eq"</span><span style="color:#F97583">)</span><span style="color:#F97583"> return</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> ;;</span></span>
<span class="line"><span style="color:#F97583">        esac</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Use dpkg for Debian-style version comparison (handles epochs, revisions)</span></span>
<span class="line"><span style="color:#B392F0">    dpkg</span><span style="color:#79B8FF"> --compare-versions</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version1</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$operator</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version2</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">    comparison_result</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Log result</span></span>
<span class="line"><span style="color:#B392F0">    log_comparison_result</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version1</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$operator</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version2</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$comparison_result</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> $comparison_result</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">log_comparison</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> v1</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span><span style="color:#E1E4E8"> op</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span><span style="color:#E1E4E8"> v2</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> timestamp</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "{</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">timestamp</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$timestamp</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">type</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">version_comparison</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">version1</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$v1</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">operator</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$op</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">version2</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$v2</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">}"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$LOG_FILE</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">log_comparison_result</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> v1</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span><span style="color:#E1E4E8"> op</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span><span style="color:#E1E4E8"> v2</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span><span style="color:#E1E4E8"> result</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$4</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> timestamp</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> result_bool</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$([[ $result </span><span style="color:#F97583">-eq</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> ]] &#x26;&#x26; </span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "true"</span><span style="color:#F97583"> ||</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> "false"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "{</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">timestamp</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$timestamp</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">type</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">comparison_result</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">version1</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$v1</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">operator</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$op</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">version2</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$v2</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">result</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#E1E4E8">$result_bool</span><span style="color:#9ECBFF">}"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$LOG_FILE</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="13-unified-package-query-interface">1.3 Unified Package Query Interface</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">get_package_full_state</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    binary_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">${2</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">$package_name</span><span style="color:#FFAB70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    timestamp</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Query all sources in parallel (conceptually)</span></span>
<span class="line"><span style="color:#E1E4E8">    current_install</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">query_current_installation</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    apt_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">query_apt_package_info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">query_snap_package_info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Query upstream latest version if applicable</span></span>
<span class="line"><span style="color:#E1E4E8">    upstream_latest</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">query_upstream_latest</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Combine into unified state object</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">jq</span><span style="color:#79B8FF"> -n</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --argjson</span><span style="color:#9ECBFF"> current</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$current_install</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --argjson</span><span style="color:#9ECBFF"> apt</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$apt_info</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --argjson</span><span style="color:#9ECBFF"> snap</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --argjson</span><span style="color:#9ECBFF"> upstream</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$upstream_latest</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --arg</span><span style="color:#9ECBFF"> timestamp</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$timestamp</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">        '{</span></span>
<span class="line"><span style="color:#9ECBFF">            timestamp: $timestamp,</span></span>
<span class="line"><span style="color:#9ECBFF">            package_name: $ARGS.positional[0],</span></span>
<span class="line"><span style="color:#9ECBFF">            binary_name: $ARGS.positional[1],</span></span>
<span class="line"><span style="color:#9ECBFF">            current_installation: $current,</span></span>
<span class="line"><span style="color:#9ECBFF">            apt: $apt,</span></span>
<span class="line"><span style="color:#9ECBFF">            snap: $snap,</span></span>
<span class="line"><span style="color:#9ECBFF">            upstream: $upstream</span></span>
<span class="line"><span style="color:#9ECBFF">        }'</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --args</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">query_upstream_latest</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        gh</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # GitHub CLI: Query GitHub API</span></span>
<span class="line"><span style="color:#E1E4E8">            latest</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">curl</span><span style="color:#79B8FF"> -s</span><span style="color:#9ECBFF"> https://api.github.com/repos/cli/cli/releases/latest</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                    jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.tag_name'</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> sed</span><span style="color:#9ECBFF"> 's/^v//'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#79B8FF">                source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "github_api",</span></span>
<span class="line"><span style="color:#B392F0">                latest_version:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$latest</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">                url:</span><span style="color:#9ECBFF"> "https://github.com/cli/cli"</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        node</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Node.js: Query nodejs.org API</span></span>
<span class="line"><span style="color:#E1E4E8">            latest</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">curl</span><span style="color:#79B8FF"> -s</span><span style="color:#9ECBFF"> https://nodejs.org/dist/index.json</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                    jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.[0].version'</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> sed</span><span style="color:#9ECBFF"> 's/^v//'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#79B8FF">                source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "nodejs_api",</span></span>
<span class="line"><span style="color:#B392F0">                latest_version:</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$latest</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#B392F0">                url:</span><span style="color:#9ECBFF"> "https://nodejs.org"</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">        *)</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#9ECBFF"> {</span></span>
<span class="line"><span style="color:#79B8FF">                source</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> "unknown",</span></span>
<span class="line"><span style="color:#B392F0">                latest_version:</span><span style="color:#9ECBFF"> "unknown"</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="2-tool-priority-decision-logic">2. Tool Priority Decision Logic</h2>
<h3 id="21-decision-criteria-framework">2.1 Decision Criteria Framework</h3>
<h4 id="priority-matrix">Priority Matrix</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Decision Factors (in priority order):</span></span>
<span class="line"><span>1. Constitutional Requirements (from CLAUDE.md)</span></span>
<span class="line"><span>2. Official Source Preference</span></span>
<span class="line"><span>3. Version Currency (newer is better)</span></span>
<span class="line"><span>4. Maintenance Status (actively maintained)</span></span>
<span class="line"><span>5. Security &#x26; Publisher Verification</span></span>
<span class="line"><span>6. System Integration (confinement, permissions)</span></span>
<span class="line"><span>7. Performance Characteristics</span></span></code></pre>
<h4 id="decision-tree-pseudocode">Decision Tree Pseudocode</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">decide_preferred_source</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Extract state information</span></span>
<span class="line"><span style="color:#E1E4E8">    current_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    current_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    apt_available</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.apt.available'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    apt_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.apt.candidate'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    snap_available</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.snap.available'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.snap.stable_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_verified</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.snap.publisher_verified'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_confinement</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.snap.confinement'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    upstream_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.upstream.latest_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 1: Check constitutional requirements</span></span>
<span class="line"><span style="color:#E1E4E8">    constitutional_preference</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">check_constitutional_preference</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-n</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$constitutional_preference</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_decision</span><span style="color:#9ECBFF"> "constitutional_requirement"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                    "Package </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF"> requires source: </span><span style="color:#E1E4E8">$constitutional_preference</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$constitutional_preference</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 2: Official source preference</span></span>
<span class="line"><span style="color:#6A737D">    # For packages from official publishers, prefer their native distribution</span></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        gh</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # GitHub CLI: Official apt repo is preferred</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$apt_available</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]] &#x26;&#x26; [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$apt_version</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> !=</span><span style="color:#9ECBFF"> "(none)"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#6A737D">                # Check if apt version is official GitHub repository</span></span>
<span class="line"><span style="color:#E1E4E8">                apt_repo</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.apt.repository_info'</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                          grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "cli.github.com"</span><span style="color:#E1E4E8"> &#x26;&#x26; </span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "official"</span><span style="color:#F97583"> ||</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> "ubuntu"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">                if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$apt_repo</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "official"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                    log_decision</span><span style="color:#9ECBFF"> "official_source"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                                "Using official GitHub CLI apt repository"</span></span>
<span class="line"><span style="color:#79B8FF">                    echo</span><span style="color:#9ECBFF"> "apt"</span></span>
<span class="line"><span style="color:#F97583">                    return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">                fi</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        node</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Node.js: fnm is preferred per CLAUDE.md</span></span>
<span class="line"><span style="color:#B392F0">            log_decision</span><span style="color:#9ECBFF"> "version_manager_preferred"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                        "Node.js managed via fnm (not apt/snap)"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "fnm"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        ghostty</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Ghostty: Snap with classic confinement preferred, then source</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$snap_available</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]] &#x26;&#x26; </span><span style="color:#79B8FF">\</span></span>
<span class="line"><span style="color:#E1E4E8">               [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$snap_verified</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]] &#x26;&#x26; </span><span style="color:#79B8FF">\</span></span>
<span class="line"><span style="color:#E1E4E8">               [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$snap_confinement</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "classic"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_decision</span><span style="color:#9ECBFF"> "snap_classic_verified"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                            "Ghostty snap has verified publisher and classic confinement"</span></span>
<span class="line"><span style="color:#79B8FF">                echo</span><span style="color:#9ECBFF"> "snap"</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">            log_decision</span><span style="color:#9ECBFF"> "source_build"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                        "Ghostty: Building from source for optimal performance"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "source"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 3: Version currency analysis</span></span>
<span class="line"><span style="color:#E1E4E8">    versions</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">        "</span><span style="color:#E1E4E8">$apt_version</span><span style="color:#9ECBFF">:apt"</span></span>
<span class="line"><span style="color:#9ECBFF">        "</span><span style="color:#E1E4E8">$snap_version</span><span style="color:#9ECBFF">:snap"</span></span>
<span class="line"><span style="color:#9ECBFF">        "</span><span style="color:#E1E4E8">$current_version</span><span style="color:#9ECBFF">:current"</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Find newest version</span></span>
<span class="line"><span style="color:#E1E4E8">    newest_version</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">""</span></span>
<span class="line"><span style="color:#E1E4E8">    newest_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> version_pair </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">versions</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#E1E4E8">        version</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"${</span><span style="color:#E1E4E8">version_pair</span><span style="color:#F97583">%%:*</span><span style="color:#9ECBFF">}"</span></span>
<span class="line"><span style="color:#E1E4E8">        source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"${</span><span style="color:#E1E4E8">version_pair</span><span style="color:#F97583">##*:</span><span style="color:#9ECBFF">}"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "(none)"</span><span style="color:#E1E4E8"> ]] </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "unknown"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">            continue</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-z</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$newest_version</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]] </span><span style="color:#F97583">||</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">           compare_versions</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$version</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "gt"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$newest_version</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">            newest_version</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">            newest_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 4: If current is newest, keep current</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$newest_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "current"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_decision</span><span style="color:#9ECBFF"> "current_is_newest"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                    "Current installation (</span><span style="color:#E1E4E8">$current_source</span><span style="color:#E1E4E8"> $current_version</span><span style="color:#9ECBFF">) is newest"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 5: Security and verification for snap</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$newest_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "snap"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$snap_verified</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> !=</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            log_decision</span><span style="color:#9ECBFF"> "snap_unverified_rejected"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                        "Snap version is newest but publisher unverified, checking apt"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$apt_available</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">                echo</span><span style="color:#9ECBFF"> "apt"</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # Check confinement for terminal applications</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$snap_confinement</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "strict"</span><span style="color:#E1E4E8"> ]] &#x26;&#x26; </span><span style="color:#79B8FF">\</span></span>
<span class="line"><span style="color:#B392F0">           is_terminal_application</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            log_decision</span><span style="color:#9ECBFF"> "snap_strict_terminal_rejected"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                        "Terminal app with strict confinement rejected"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "apt"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 6: Default to newest available</span></span>
<span class="line"><span style="color:#B392F0">    log_decision</span><span style="color:#9ECBFF"> "newest_version_selected"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                "Selected </span><span style="color:#E1E4E8">$newest_source</span><span style="color:#9ECBFF"> with version </span><span style="color:#E1E4E8">$newest_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$newest_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">check_constitutional_preference</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Parse CLAUDE.md for package-specific requirements</span></span>
<span class="line"><span style="color:#6A737D">    # This would actually grep/parse the CLAUDE.md file</span></span>
<span class="line"><span style="color:#6A737D">    # For design purposes, showing the logic:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        node</span><span style="color:#F97583">|</span><span style="color:#DBEDFF">nodejs</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # CLAUDE.md specifies fnm for Node.js management</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "fnm"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        ghostty</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # CLAUDE.md specifies source build with specific optimizations</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "source"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">        *)</span></span>
<span class="line"><span style="color:#6A737D">            # No constitutional preference</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">is_terminal_application</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    terminal_apps</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"ghostty"</span><span style="color:#9ECBFF"> "gnome-terminal"</span><span style="color:#9ECBFF"> "alacritty"</span><span style="color:#9ECBFF"> "kitty"</span><span style="color:#9ECBFF"> "wezterm"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> app </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">terminal_apps</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$app</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">log_decision</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    decision_type</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    reason</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    timestamp</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "{</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">timestamp</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$timestamp</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">type</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">decision</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">decision_type</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$decision_type</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">,</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">reason</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">:</span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$reason</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">}"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$DECISION_LOG</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="3-clean-migration-strategy">3. Clean Migration Strategy</h2>
<h3 id="31-pre-migration-state-capture">3.1 Pre-Migration State Capture</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">capture_pre_migration_state</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"/tmp/package-migration-</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">    mkdir</span><span style="color:#79B8FF"> -p</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Capture complete package state</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/pre_state.json"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Capture dependency tree</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#B392F0"> dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -qE</span><span style="color:#9ECBFF"> "^ii\s+</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">\s"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        apt-cache</span><span style="color:#9ECBFF"> depends</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/dependencies.txt"</span></span>
<span class="line"><span style="color:#B392F0">        apt-cache</span><span style="color:#9ECBFF"> rdepends</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/reverse_dependencies.txt"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Capture configuration files</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-d</span><span style="color:#9ECBFF"> "/etc/</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        tar</span><span style="color:#79B8FF"> -czf</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/config_backup.tar.gz"</span><span style="color:#9ECBFF"> "/etc/</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Capture user-specific configuration</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> user_home </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> /home/*</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#E1E4E8">        user</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">basename</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$user_home</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-d</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$user_home</span><span style="color:#9ECBFF">/.config/</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            tar</span><span style="color:#79B8FF"> -czf</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/config_${</span><span style="color:#E1E4E8">user</span><span style="color:#9ECBFF">}_backup.tar.gz"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                "</span><span style="color:#E1E4E8">$user_home</span><span style="color:#9ECBFF">/.config/</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Capture package file list</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#B392F0"> dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -qE</span><span style="color:#9ECBFF"> "^ii\s+</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">\s"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        dpkg</span><span style="color:#79B8FF"> -L</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/file_list.txt"</span></span>
<span class="line"><span style="color:#F97583">    elif</span><span style="color:#B392F0"> snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "^</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        find</span><span style="color:#9ECBFF"> /snap/"</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> -type</span><span style="color:#9ECBFF"> f</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/file_list.txt"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Create migration metadata</span></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/metadata.json"</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#9ECBFF">{</span></span>
<span class="line"><span style="color:#9ECBFF">    "migration_id": "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "package_name": "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "timestamp": "$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#9ECBFF">)",</span></span>
<span class="line"><span style="color:#9ECBFF">    "hostname": "$(</span><span style="color:#B392F0">hostname</span><span style="color:#9ECBFF">)",</span></span>
<span class="line"><span style="color:#9ECBFF">    "user": "$(</span><span style="color:#B392F0">whoami</span><span style="color:#9ECBFF">)",</span></span>
<span class="line"><span style="color:#9ECBFF">    "state_dir": "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">}</span></span>
<span class="line"><span style="color:#9ECBFF">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Pre-migration state captured: </span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="32-complete-removal-with-tracking">3.2 Complete Removal with Tracking</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">remove_package_completely</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    installation_source</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    removal_log</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/removal_log.txt"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Starting complete removal of </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF"> from </span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        apt</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Get list of files before removal</span></span>
<span class="line"><span style="color:#B392F0">            dpkg</span><span style="color:#79B8FF"> -L</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/removed_files.txt"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Remove package and dependencies</span></span>
<span class="line"><span style="color:#B392F0">            log_info</span><span style="color:#9ECBFF"> "Removing apt package: </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">            apt-get</span><span style="color:#9ECBFF"> remove</span><span style="color:#79B8FF"> --purge</span><span style="color:#79B8FF"> -y</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$removal_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"><span style="color:#E1E4E8">            removal_status</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Check for orphaned dependencies</span></span>
<span class="line"><span style="color:#E1E4E8">            orphaned</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">apt-get</span><span style="color:#9ECBFF"> autoremove</span><span style="color:#79B8FF"> --dry-run</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -oP</span><span style="color:#9ECBFF"> '\d+ upgraded.*\d+ not upgraded'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">            log_info</span><span style="color:#9ECBFF"> "Orphaned dependencies: </span><span style="color:#E1E4E8">$orphaned</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Remove orphaned dependencies</span></span>
<span class="line"><span style="color:#B392F0">            apt-get</span><span style="color:#9ECBFF"> autoremove</span><span style="color:#79B8FF"> -y</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$removal_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Clean package cache</span></span>
<span class="line"><span style="color:#B392F0">            apt-get</span><span style="color:#9ECBFF"> clean</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$removal_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBEDFF">        snap</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Snap maintains its own state, capture before removal</span></span>
<span class="line"><span style="color:#B392F0">            snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/snap_list_before.txt"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"><span style="color:#B392F0">            snap</span><span style="color:#9ECBFF"> info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/snap_info_before.txt"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">            log_info</span><span style="color:#9ECBFF"> "Removing snap package: </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">            snap</span><span style="color:#9ECBFF"> remove</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$removal_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"><span style="color:#E1E4E8">            removal_status</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        *)</span></span>
<span class="line"><span style="color:#B392F0">            log_error</span><span style="color:#9ECBFF"> "Unknown installation source: </span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Verify removal</span></span>
<span class="line"><span style="color:#B392F0">    verify_complete_removal</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">    verification_status</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Log removal summary</span></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/removal_summary.json"</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#9ECBFF">{</span></span>
<span class="line"><span style="color:#9ECBFF">    "migration_id": "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "package_name": "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "installation_source": "</span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "removal_status": </span><span style="color:#E1E4E8">$removal_status</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "verification_status": </span><span style="color:#E1E4E8">$verification_status</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "timestamp": "$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#9ECBFF">}</span></span>
<span class="line"><span style="color:#9ECBFF">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> $removal_status</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">verify_complete_removal</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    installation_source</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    verification_log</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/verification_log.txt"</span></span>
<span class="line"><span style="color:#E1E4E8">    leftovers_found</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Verifying complete removal of </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check package databases</span></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        apt</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#B392F0"> dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -qE</span><span style="color:#9ECBFF"> "^ii\s+</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">\s"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_error</span><span style="color:#9ECBFF"> "Package still in dpkg database"</span></span>
<span class="line"><span style="color:#B392F0">                dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">                leftovers_found</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">1</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        snap</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#B392F0"> snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "^</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_error</span><span style="color:#9ECBFF"> "Package still in snap list"</span></span>
<span class="line"><span style="color:#B392F0">                snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">                leftovers_found</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">1</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check for leftover binaries</span></span>
<span class="line"><span style="color:#E1E4E8">    binary_name</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">${package_name}</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_warning</span><span style="color:#9ECBFF"> "Binary still in PATH: $(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">")"</span></span>
<span class="line"><span style="color:#79B8FF">        which</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        leftovers_found</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check for leftover files (from pre-removal list)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/removed_files.txt"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">        while</span><span style="color:#E1E4E8"> IFS</span><span style="color:#F97583">=</span><span style="color:#79B8FF"> read</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> file_path</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-e</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$file_path</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_warning</span><span style="color:#9ECBFF"> "Leftover file: </span><span style="color:#E1E4E8">$file_path</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">                echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$file_path</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">                leftovers_found</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">1</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#F97583">        done</span><span style="color:#F97583"> &#x3C;</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/removed_files.txt"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check for leftover configuration</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-d</span><span style="color:#9ECBFF"> "/etc/</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_warning</span><span style="color:#9ECBFF"> "Leftover configuration: /etc/</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">        ls</span><span style="color:#79B8FF"> -la</span><span style="color:#9ECBFF"> "/etc/</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        leftovers_found</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Summary</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ $leftovers_found </span><span style="color:#F97583">-eq</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "Complete removal verified: no leftovers found"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> '{"verification":"success","leftovers":false}'</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/verification_result.json"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_warning</span><span style="color:#9ECBFF"> "Leftovers found, see: </span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> '{"verification":"warning","leftovers":true,"log":"'"</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"'"}'</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/verification_result.json"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="33-new-source-installation">3.3 New Source Installation</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">install_from_new_source</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    new_source</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    installation_log</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/installation_log.txt"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Installing </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF"> from </span><span style="color:#E1E4E8">$new_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$new_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        apt</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Update package cache</span></span>
<span class="line"><span style="color:#B392F0">            apt-get</span><span style="color:#9ECBFF"> update</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Install package</span></span>
<span class="line"><span style="color:#B392F0">            apt-get</span><span style="color:#9ECBFF"> install</span><span style="color:#79B8FF"> -y</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"><span style="color:#E1E4E8">            installation_status</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Get installed version</span></span>
<span class="line"><span style="color:#E1E4E8">            installed_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "^ii.*</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF"> "</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $3}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBEDFF">        snap</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Determine confinement</span></span>
<span class="line"><span style="color:#E1E4E8">            snap_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">snap</span><span style="color:#9ECBFF"> info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">            confinement</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "confinement:"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Install with appropriate flags</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$confinement</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "classic"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                snap</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> --classic</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"><span style="color:#F97583">            else</span></span>
<span class="line"><span style="color:#B392F0">                snap</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#E1E4E8">            installation_status</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Get installed version</span></span>
<span class="line"><span style="color:#E1E4E8">            installed_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> tail</span><span style="color:#79B8FF"> -1</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        *)</span></span>
<span class="line"><span style="color:#B392F0">            log_error</span><span style="color:#9ECBFF"> "Unknown installation source: </span><span style="color:#E1E4E8">$new_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Verify installation</span></span>
<span class="line"><span style="color:#B392F0">    verify_successful_installation</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$new_source</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">    verification_status</span><span style="color:#F97583">=</span><span style="color:#79B8FF">$?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Log installation summary</span></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/installation_summary.json"</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#9ECBFF">{</span></span>
<span class="line"><span style="color:#9ECBFF">    "migration_id": "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "package_name": "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "new_source": "</span><span style="color:#E1E4E8">$new_source</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "installation_status": </span><span style="color:#E1E4E8">$installation_status</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "verification_status": </span><span style="color:#E1E4E8">$verification_status</span><span style="color:#9ECBFF">,</span></span>
<span class="line"><span style="color:#9ECBFF">    "installed_version": "</span><span style="color:#E1E4E8">$installed_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "timestamp": "$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#9ECBFF">}</span></span>
<span class="line"><span style="color:#9ECBFF">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> $installation_status</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">verify_successful_installation</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    new_source</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    verification_log</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/post_install_verification.txt"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Verifying successful installation of </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check package database</span></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$new_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        apt</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -qE</span><span style="color:#9ECBFF"> "^ii\s+</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">\s"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_error</span><span style="color:#9ECBFF"> "Package not found in dpkg database"</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">            dpkg</span><span style="color:#79B8FF"> -l</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        snap</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "^</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_error</span><span style="color:#9ECBFF"> "Package not found in snap list"</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">            snap</span><span style="color:#9ECBFF"> list</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check binary availability</span></span>
<span class="line"><span style="color:#E1E4E8">    binary_name</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">${package_name}</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Binary not available in PATH"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    which</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check version</span></span>
<span class="line"><span style="color:#E1E4E8">    version_output</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_version_from_binary</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$binary_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$version_output</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "unknown"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_warning</span><span style="color:#9ECBFF"> "Unable to determine version from binary"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "Installed version: </span><span style="color:#E1E4E8">$version_output</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "Binary version: </span><span style="color:#E1E4E8">$version_output</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> >></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verification_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_success</span><span style="color:#9ECBFF"> "Installation verified successfully"</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="34-configuration-restoration">3.4 Configuration Restoration</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">restore_user_configuration</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Restoring user configuration for </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Restore system configuration if backed up</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/config_backup.tar.gz"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_info</span><span style="color:#9ECBFF"> "Restoring system configuration"</span></span>
<span class="line"><span style="color:#B392F0">        tar</span><span style="color:#79B8FF"> -xzf</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/config_backup.tar.gz"</span><span style="color:#79B8FF"> -C</span><span style="color:#9ECBFF"> /</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Restore user-specific configurations</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> backup_file </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"/config_*_backup.tar.gz</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$backup_file</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">            user</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">basename</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$backup_file</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> sed</span><span style="color:#9ECBFF"> 's/config_\(.*\)_backup.tar.gz/\1/'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">            log_info</span><span style="color:#9ECBFF"> "Restoring configuration for user: </span><span style="color:#E1E4E8">$user</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">            tar</span><span style="color:#79B8FF"> -xzf</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$backup_file</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> -C</span><span style="color:#9ECBFF"> /</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_success</span><span style="color:#9ECBFF"> "Configuration restoration complete"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="35-rollback-mechanism">3.5 Rollback Mechanism</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">rollback_migration</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_warning</span><span style="color:#9ECBFF"> "Initiating rollback for migration </span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Load pre-migration state</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">!</span><span style="color:#F97583"> -f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/pre_state.json"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Pre-migration state not found, cannot rollback"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    pre_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">cat</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/pre_state.json"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    original_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$pre_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    original_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$pre_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Rollback target: </span><span style="color:#E1E4E8">$original_source</span><span style="color:#E1E4E8"> $original_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Remove new installation</span></span>
<span class="line"><span style="color:#E1E4E8">    current_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">query_current_installation</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                    jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-n</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]] &#x26;&#x26; [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> !=</span><span style="color:#9ECBFF"> "unknown"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        remove_package_completely</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                                 "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">-rollback"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/rollback"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Reinstall original version</span></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$original_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        apt</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Try to install specific version</span></span>
<span class="line"><span style="color:#B392F0">            apt-get</span><span style="color:#9ECBFF"> install</span><span style="color:#79B8FF"> -y</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">=</span><span style="color:#E1E4E8">$original_version</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ||</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">            apt-get</span><span style="color:#9ECBFF"> install</span><span style="color:#79B8FF"> -y</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        snap</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Snap doesn't support specific version reinstall easily</span></span>
<span class="line"><span style="color:#6A737D">            # Install latest stable</span></span>
<span class="line"><span style="color:#B392F0">            snap</span><span style="color:#9ECBFF"> install</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Restore configuration</span></span>
<span class="line"><span style="color:#B392F0">    restore_user_configuration</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_success</span><span style="color:#9ECBFF"> "Rollback complete"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Create rollback summary</span></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/rollback_summary.json"</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#9ECBFF">{</span></span>
<span class="line"><span style="color:#9ECBFF">    "migration_id": "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "rollback_timestamp": "$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#9ECBFF">)",</span></span>
<span class="line"><span style="color:#9ECBFF">    "original_source": "</span><span style="color:#E1E4E8">$original_source</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "original_version": "</span><span style="color:#E1E4E8">$original_version</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "restored": true</span></span>
<span class="line"><span style="color:#9ECBFF">}</span></span>
<span class="line"><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="4-complete-migration-orchestration">4. Complete Migration Orchestration</h2>
<h3 id="41-main-migration-function">4.1 Main Migration Function</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">migrate_package</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    force</span><span style="color:#F97583">=</span><span style="color:#FFAB70">${2</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">false</span><span style="color:#FFAB70">}</span><span style="color:#6A737D">  # Optional: force migration even if same source</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Generate unique migration ID</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"$(</span><span style="color:#B392F0">date</span><span style="color:#9ECBFF"> +%Y%m%d-%H%M%S)-</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">-</span><span style="color:#79B8FF">$$</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Package Migration: </span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Migration ID: </span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 1: Get complete current state</span></span>
<span class="line"><span style="color:#B392F0">    log_step</span><span style="color:#9ECBFF"> "1/7"</span><span style="color:#9ECBFF"> "Querying package state"</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    current_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    current_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "unknown"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Package not currently installed"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Current: </span><span style="color:#E1E4E8">$current_source</span><span style="color:#E1E4E8"> $current_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 2: Decide preferred source</span></span>
<span class="line"><span style="color:#B392F0">    log_step</span><span style="color:#9ECBFF"> "2/7"</span><span style="color:#9ECBFF"> "Determining preferred source"</span></span>
<span class="line"><span style="color:#E1E4E8">    preferred_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">decide_preferred_source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Preferred source: </span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if migration needed</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]] &#x26;&#x26; [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$force</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> !=</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "Already using preferred source, no migration needed"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 3: Capture pre-migration state</span></span>
<span class="line"><span style="color:#B392F0">    log_step</span><span style="color:#9ECBFF"> "3/7"</span><span style="color:#9ECBFF"> "Capturing pre-migration state"</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">capture_pre_migration_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 4: Remove old installation</span></span>
<span class="line"><span style="color:#B392F0">    log_step</span><span style="color:#9ECBFF"> "4/7"</span><span style="color:#9ECBFF"> "Removing old installation"</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> remove_package_completely</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                                   "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Removal failed, initiating rollback"</span></span>
<span class="line"><span style="color:#B392F0">        rollback_migration</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 5: Install from new source</span></span>
<span class="line"><span style="color:#B392F0">    log_step</span><span style="color:#9ECBFF"> "5/7"</span><span style="color:#9ECBFF"> "Installing from new source"</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> install_from_new_source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                                 "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Installation failed, initiating rollback"</span></span>
<span class="line"><span style="color:#B392F0">        rollback_migration</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 6: Restore configuration</span></span>
<span class="line"><span style="color:#B392F0">    log_step</span><span style="color:#9ECBFF"> "6/7"</span><span style="color:#9ECBFF"> "Restoring user configuration"</span></span>
<span class="line"><span style="color:#B392F0">    restore_user_configuration</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # STEP 7: Capture post-migration state</span></span>
<span class="line"><span style="color:#B392F0">    log_step</span><span style="color:#9ECBFF"> "7/7"</span><span style="color:#9ECBFF"> "Capturing post-migration state"</span></span>
<span class="line"><span style="color:#E1E4E8">    post_state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$post_state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/post_state.json"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Create migration summary</span></span>
<span class="line"><span style="color:#B392F0">    create_migration_summary</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_success</span><span style="color:#9ECBFF"> "Migration completed successfully"</span></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "Migration details: </span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">create_migration_summary</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    pre_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">cat</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/pre_state.json"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    post_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">cat</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/post_state.json"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    pre_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$pre_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    pre_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$pre_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    post_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$post_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    post_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$post_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/migration_summary.json"</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#9ECBFF">{</span></span>
<span class="line"><span style="color:#9ECBFF">    "migration_id": "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "package_name": "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "timestamp": "$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#9ECBFF">)",</span></span>
<span class="line"><span style="color:#9ECBFF">    "hostname": "$(</span><span style="color:#B392F0">hostname</span><span style="color:#9ECBFF">)",</span></span>
<span class="line"><span style="color:#9ECBFF">    "before": {</span></span>
<span class="line"><span style="color:#9ECBFF">        "source": "</span><span style="color:#E1E4E8">$pre_source</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">        "version": "</span><span style="color:#E1E4E8">$pre_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">    },</span></span>
<span class="line"><span style="color:#9ECBFF">    "after": {</span></span>
<span class="line"><span style="color:#9ECBFF">        "source": "</span><span style="color:#E1E4E8">$post_source</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">        "version": "</span><span style="color:#E1E4E8">$post_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">    },</span></span>
<span class="line"><span style="color:#9ECBFF">    "state_dir": "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">",</span></span>
<span class="line"><span style="color:#9ECBFF">    "status": "success"</span></span>
<span class="line"><span style="color:#9ECBFF">}</span></span>
<span class="line"><span style="color:#9ECBFF">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Human-readable summary</span></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/MIGRATION_SUMMARY.txt"</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#9ECBFF">Package Migration Summary</span></span>
<span class="line"><span style="color:#9ECBFF">========================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Migration ID: </span><span style="color:#E1E4E8">$migration_id</span></span>
<span class="line"><span style="color:#9ECBFF">Package: </span><span style="color:#E1E4E8">$package_name</span></span>
<span class="line"><span style="color:#9ECBFF">Date: $(</span><span style="color:#B392F0">date</span><span style="color:#9ECBFF">)</span></span>
<span class="line"><span style="color:#9ECBFF">Hostname: $(</span><span style="color:#B392F0">hostname</span><span style="color:#9ECBFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Before Migration:</span></span>
<span class="line"><span style="color:#9ECBFF">  Source: </span><span style="color:#E1E4E8">$pre_source</span></span>
<span class="line"><span style="color:#9ECBFF">  Version: </span><span style="color:#E1E4E8">$pre_version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">After Migration:</span></span>
<span class="line"><span style="color:#9ECBFF">  Source: </span><span style="color:#E1E4E8">$post_source</span></span>
<span class="line"><span style="color:#9ECBFF">  Version: </span><span style="color:#E1E4E8">$post_version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Status: SUCCESS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Detailed logs available in: </span><span style="color:#E1E4E8">$state_dir</span></span>
<span class="line"><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">log_step</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    step</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    description</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#B392F0">    log_info</span><span style="color:#9ECBFF"> "[</span><span style="color:#E1E4E8">$step</span><span style="color:#9ECBFF">] </span><span style="color:#E1E4E8">$description</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">log_section</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    section</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "============================================================================"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  </span><span style="color:#E1E4E8">$section</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "============================================================================"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="5-example-implementation-for-common-tools">5. Example Implementation for Common Tools</h2>
<h3 id="51-github-cli-gh-migration">5.1 GitHub CLI (gh) Migration</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D"># Example: Migrate GitHub CLI from Ubuntu repository to official apt repository</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">set</span><span style="color:#79B8FF"> -euo</span><span style="color:#9ECBFF"> pipefail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">SCRIPT_DIR</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"$(</span><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> "$(</span><span style="color:#B392F0">dirname</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">BASH_SOURCE</span><span style="color:#9ECBFF">[0]}")" &#x26;&#x26; </span><span style="color:#79B8FF">pwd</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#79B8FF">source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$SCRIPT_DIR</span><span style="color:#9ECBFF">/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">migrate_gh_cli</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "GitHub CLI Migration Example"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Query current state</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Current State:"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#9ECBFF"> '{</span></span>
<span class="line"><span style="color:#9ECBFF">        current: .current_installation,</span></span>
<span class="line"><span style="color:#9ECBFF">        apt: {available: .apt.available, version: .apt.candidate},</span></span>
<span class="line"><span style="color:#9ECBFF">        snap: {available: .snap.available, version: .snap.stable_version},</span></span>
<span class="line"><span style="color:#9ECBFF">        upstream: .upstream</span></span>
<span class="line"><span style="color:#9ECBFF">    }'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Show decision reasoning</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Decision Analysis:"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if official GitHub repository is configured</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#B392F0"> apt-cache</span><span style="color:#9ECBFF"> policy</span><span style="color:#9ECBFF"> gh</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "cli.github.com"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "✓ Official GitHub CLI repository configured"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  Recommendation: Use apt (official source)"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "⚠ Ubuntu universe repository detected"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  Current version may be outdated"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  Recommendation: Add official repository or use snap"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Version comparison</span></span>
<span class="line"><span style="color:#E1E4E8">    apt_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.apt.candidate'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.snap.stable_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    upstream_version</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.upstream.latest_version'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Version Comparison:"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  apt:      </span><span style="color:#E1E4E8">$apt_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  snap:     </span><span style="color:#E1E4E8">$snap_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  upstream: </span><span style="color:#E1E4E8">$upstream_version</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Perform migration if needed</span></span>
<span class="line"><span style="color:#E1E4E8">    preferred_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">decide_preferred_source</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    current_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> !=</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "Migration Required: </span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF"> → </span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">        read</span><span style="color:#79B8FF"> -p</span><span style="color:#9ECBFF"> "Proceed with migration? (y/N): "</span><span style="color:#9ECBFF"> confirm</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$confirm</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "y"</span><span style="color:#E1E4E8"> ]] </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$confirm</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "Y"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            migrate_package</span><span style="color:#9ECBFF"> "gh"</span></span>
<span class="line"><span style="color:#F97583">        else</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "Migration cancelled"</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "✓ Already using optimal source: </span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Run migration</span></span>
<span class="line"><span style="color:#B392F0">migrate_gh_cli</span></span></code></pre>
<h3 id="52-nodejs-verification-fnm-managed">5.2 Node.js Verification (fnm managed)</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D"># Example: Verify Node.js is properly managed via fnm (per CLAUDE.md requirements)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">set</span><span style="color:#79B8FF"> -euo</span><span style="color:#9ECBFF"> pipefail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">SCRIPT_DIR</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"$(</span><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> "$(</span><span style="color:#B392F0">dirname</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">BASH_SOURCE</span><span style="color:#9ECBFF">[0]}")" &#x26;&#x26; </span><span style="color:#79B8FF">pwd</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#79B8FF">source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$SCRIPT_DIR</span><span style="color:#9ECBFF">/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">verify_nodejs_management</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Node.js Management Verification"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Query all possible Node.js sources</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "nodejs"</span><span style="color:#9ECBFF"> "node"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check constitutional requirement</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Constitutional Requirement: Node.js must be managed via fnm"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if fnm is installed</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> fnm</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "fnm not installed"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "Action required: Install fnm"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  curl -fsSL https://fnm.vercel.app/install | bash"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_success</span><span style="color:#9ECBFF"> "fnm installed: $(</span><span style="color:#B392F0">fnm</span><span style="color:#79B8FF"> --version</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check Node.js source</span></span>
<span class="line"><span style="color:#E1E4E8">    current_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    node_path</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> node</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> ||</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> "not found"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Current Node.js Installation:"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Source: </span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Path: </span><span style="color:#E1E4E8">$node_path</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Version: $(</span><span style="color:#B392F0">node</span><span style="color:#79B8FF"> --version</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null </span><span style="color:#F97583">||</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> 'not installed')"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Verify fnm management</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$node_path</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "fnm"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "Node.js correctly managed via fnm"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "fnm managed versions:"</span></span>
<span class="line"><span style="color:#B392F0">        fnm</span><span style="color:#9ECBFF"> list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_warning</span><span style="color:#9ECBFF"> "Node.js not managed via fnm"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # Check for conflicting installations</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "apt"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            log_warning</span><span style="color:#9ECBFF"> "Node.js installed via apt (violates CLAUDE.md)"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "Action required: Remove apt-managed Node.js"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "  sudo apt-get remove --purge nodejs npm"</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "snap"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            log_warning</span><span style="color:#9ECBFF"> "Node.js installed via snap (violates CLAUDE.md)"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "Action required: Remove snap-managed Node.js"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "  sudo snap remove node"</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "After removal, install via fnm:"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  fnm install --lts"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  fnm use lts-latest"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  fnm default lts-latest"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Run verification</span></span>
<span class="line"><span style="color:#B392F0">verify_nodejs_management</span></span></code></pre>
<hr>
<h2 id="6-test-cases">6. Test Cases</h2>
<h3 id="61-test-suite-structure">6.1 Test Suite Structure</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D"># Test suite for package management verification and migration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">set</span><span style="color:#79B8FF"> -euo</span><span style="color:#9ECBFF"> pipefail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">SCRIPT_DIR</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"$(</span><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> "$(</span><span style="color:#B392F0">dirname</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">BASH_SOURCE</span><span style="color:#9ECBFF">[0]}")" &#x26;&#x26; </span><span style="color:#79B8FF">pwd</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#79B8FF">source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$SCRIPT_DIR</span><span style="color:#9ECBFF">/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Test counter</span></span>
<span class="line"><span style="color:#E1E4E8">TESTS_RUN</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">0</span></span>
<span class="line"><span style="color:#E1E4E8">TESTS_PASSED</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">0</span></span>
<span class="line"><span style="color:#E1E4E8">TESTS_FAILED</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Test helper functions</span></span>
<span class="line"><span style="color:#B392F0">assert_equals</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    TESTS_RUN</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">TESTS_RUN</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> expected</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> actual</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> test_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$expected</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$actual</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "PASS: </span><span style="color:#E1E4E8">$test_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        TESTS_PASSED</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">TESTS_PASSED</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "FAIL: </span><span style="color:#E1E4E8">$test_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  Expected: </span><span style="color:#E1E4E8">$expected</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "  Actual: </span><span style="color:#E1E4E8">$actual</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        TESTS_FAILED</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">TESTS_FAILED</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">assert_true</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    TESTS_RUN</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">TESTS_RUN</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> condition</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> test_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> $condition; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "PASS: </span><span style="color:#E1E4E8">$test_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        TESTS_PASSED</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">TESTS_PASSED</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "FAIL: </span><span style="color:#E1E4E8">$test_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        TESTS_FAILED</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">TESTS_FAILED</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"><span style="color:#6A737D"># TEST CATEGORY 1: Version Comparison</span></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test_version_comparison</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Test Category: Version Comparison"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 1: Basic version comparison</span></span>
<span class="line"><span style="color:#B392F0">    compare_versions</span><span style="color:#9ECBFF"> "2.0.0"</span><span style="color:#9ECBFF"> "gt"</span><span style="color:#9ECBFF"> "1.0.0"</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "2.0.0 > 1.0.0"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 2: Equal versions</span></span>
<span class="line"><span style="color:#B392F0">    compare_versions</span><span style="color:#9ECBFF"> "1.5.3"</span><span style="color:#9ECBFF"> "eq"</span><span style="color:#9ECBFF"> "1.5.3"</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "1.5.3 == 1.5.3"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 3: Complex version with suffixes</span></span>
<span class="line"><span style="color:#B392F0">    compare_versions</span><span style="color:#9ECBFF"> "2.1.0-beta"</span><span style="color:#9ECBFF"> "gt"</span><span style="color:#9ECBFF"> "2.0.9"</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "2.1.0-beta > 2.0.9"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 4: Debian-style epoch versions</span></span>
<span class="line"><span style="color:#B392F0">    compare_versions</span><span style="color:#9ECBFF"> "1:2.0"</span><span style="color:#9ECBFF"> "gt"</span><span style="color:#9ECBFF"> "1.9"</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Epoch version comparison"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 5: Handle "none" versions</span></span>
<span class="line"><span style="color:#B392F0">    compare_versions</span><span style="color:#9ECBFF"> "1.0.0"</span><span style="color:#9ECBFF"> "gt"</span><span style="color:#9ECBFF"> "(none)"</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "1.0.0 > (none)"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"><span style="color:#6A737D"># TEST CATEGORY 2: Package State Queries</span></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test_package_state_queries</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Test Category: Package State Queries"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 1: Query installed package (gh)</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    current_installed</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "true"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$current_installed</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Query installed package"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 2: Query non-existent package</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "nonexistent-package-xyz"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    current_installed</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "false"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$current_installed</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Query non-existent package"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 3: Apt availability check</span></span>
<span class="line"><span style="color:#E1E4E8">    apt_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">query_apt_package_info</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    apt_available</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$apt_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.available'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "true"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$apt_available</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Apt availability for gh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 4: Snap availability check</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">query_snap_package_info</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    snap_available</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.available'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">    # This may be true or false depending on snap store, just verify it returns</span></span>
<span class="line"><span style="color:#E1E4E8">    [[ </span><span style="color:#F97583">-n</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_available</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Snap query returns result"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"><span style="color:#6A737D"># TEST CATEGORY 3: Decision Logic</span></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test_decision_logic</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Test Category: Decision Logic"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 1: Constitutional preference (Node.js)</span></span>
<span class="line"><span style="color:#E1E4E8">    constitutional_pref</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">check_constitutional_preference</span><span style="color:#9ECBFF"> "nodejs"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "fnm"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$constitutional_pref</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Node.js constitutional preference"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 2: No constitutional preference (jq)</span></span>
<span class="line"><span style="color:#E1E4E8">    constitutional_pref</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">check_constitutional_preference</span><span style="color:#9ECBFF"> "jq"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> ""</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$constitutional_pref</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "No preference for jq"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 3: Full decision for gh</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    preferred_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">decide_preferred_source</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">    # Should prefer apt (official source) or snap, verify not empty</span></span>
<span class="line"><span style="color:#E1E4E8">    [[ </span><span style="color:#F97583">-n</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Decision returns valid source for gh"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"><span style="color:#6A737D"># TEST CATEGORY 4: State Capture and Restoration</span></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test_state_capture</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Test Category: State Capture"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 1: Capture pre-migration state</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"test-$(</span><span style="color:#B392F0">date</span><span style="color:#9ECBFF"> +%s)"</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">capture_pre_migration_state</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [[ </span><span style="color:#F97583">-d</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "State directory created"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/pre_state.json"</span><span style="color:#E1E4E8"> ]]</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Pre-state JSON created"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/metadata.json"</span><span style="color:#E1E4E8"> ]]</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Metadata JSON created"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Cleanup</span></span>
<span class="line"><span style="color:#B392F0">    rm</span><span style="color:#79B8FF"> -rf</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"><span style="color:#6A737D"># TEST CATEGORY 5: Dry-Run Migration</span></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test_dry_run_migration</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Test Category: Dry-Run Migration"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # This test simulates migration without actually modifying system</span></span>
<span class="line"><span style="color:#6A737D">    # Uses mock functions for removal/installation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 1: Migration plan generation</span></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    current_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    preferred_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">decide_preferred_source</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> !=</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_info</span><span style="color:#9ECBFF"> "Migration would be: </span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF"> → </span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">        assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "Migration plan generated"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_info</span><span style="color:#9ECBFF"> "No migration needed"</span></span>
<span class="line"><span style="color:#B392F0">        assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "Correctly identified no migration needed"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"><span style="color:#6A737D"># TEST CATEGORY 6: Logging and Audit Trail</span></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">test_logging_audit</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Test Category: Logging and Audit"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 1: Decision logging</span></span>
<span class="line"><span style="color:#E1E4E8">    test_log</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"/tmp/test-decision-log-</span><span style="color:#79B8FF">$$</span><span style="color:#9ECBFF">.json"</span></span>
<span class="line"><span style="color:#E1E4E8">    DECISION_LOG</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$test_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_decision</span><span style="color:#9ECBFF"> "test_decision"</span><span style="color:#9ECBFF"> "Test decision reason"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$test_log</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Decision log file created"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Verify JSON structure</span></span>
<span class="line"><span style="color:#B392F0">    jq</span><span style="color:#9ECBFF"> empty</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$test_log</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Decision log is valid JSON"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Cleanup</span></span>
<span class="line"><span style="color:#B392F0">    rm</span><span style="color:#79B8FF"> -f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$test_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Test 2: Version comparison logging</span></span>
<span class="line"><span style="color:#E1E4E8">    test_log</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"/tmp/test-comparison-log-</span><span style="color:#79B8FF">$$</span><span style="color:#9ECBFF">.json"</span></span>
<span class="line"><span style="color:#E1E4E8">    LOG_FILE</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$test_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    compare_versions</span><span style="color:#9ECBFF"> "2.0.0"</span><span style="color:#9ECBFF"> "gt"</span><span style="color:#9ECBFF"> "1.0.0"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$test_log</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]</span></span>
<span class="line"><span style="color:#B392F0">    assert_equals</span><span style="color:#9ECBFF"> "0"</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$?</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "Comparison log file created"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Cleanup</span></span>
<span class="line"><span style="color:#B392F0">    rm</span><span style="color:#79B8FF"> -f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$test_log</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"><span style="color:#6A737D"># Run all tests</span></span>
<span class="line"><span style="color:#6A737D"># ===================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">run_all_tests</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "============================================================================"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Package Migration System Test Suite"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "============================================================================"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    test_version_comparison</span></span>
<span class="line"><span style="color:#B392F0">    test_package_state_queries</span></span>
<span class="line"><span style="color:#B392F0">    test_decision_logic</span></span>
<span class="line"><span style="color:#B392F0">    test_state_capture</span></span>
<span class="line"><span style="color:#B392F0">    test_dry_run_migration</span></span>
<span class="line"><span style="color:#B392F0">    test_logging_audit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Summary</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "============================================================================"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Test Summary"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "============================================================================"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Tests Run: </span><span style="color:#E1E4E8">$TESTS_RUN</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Passed: </span><span style="color:#E1E4E8">$TESTS_PASSED</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Failed: </span><span style="color:#E1E4E8">$TESTS_FAILED</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ $TESTS_FAILED </span><span style="color:#F97583">-eq</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "All tests passed!"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Some tests failed"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Execute tests</span></span>
<span class="line"><span style="color:#B392F0">run_all_tests</span></span></code></pre>
<h3 id="62-integration-test-complete-migration">6.2 Integration Test: Complete Migration</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D"># Integration test: Complete package migration in test environment</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">set</span><span style="color:#79B8FF"> -euo</span><span style="color:#9ECBFF"> pipefail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">SCRIPT_DIR</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"$(</span><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> "$(</span><span style="color:#B392F0">dirname</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">BASH_SOURCE</span><span style="color:#9ECBFF">[0]}")" &#x26;&#x26; </span><span style="color:#79B8FF">pwd</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#79B8FF">source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$SCRIPT_DIR</span><span style="color:#9ECBFF">/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">integration_test_complete_migration</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Integration Test: Complete Package Migration"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # This test requires a test package that can be safely installed/removed</span></span>
<span class="line"><span style="color:#6A737D">    # Using 'figlet' as test package (small, safe, available in apt/snap)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    TEST_PACKAGE</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"figlet"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # PHASE 1: Initial state</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "PHASE 1: Capturing initial state"</span></span>
<span class="line"><span style="color:#E1E4E8">    initial_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    initial_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$initial_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$initial_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "unknown"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "Test package not installed, installing via apt for test"</span></span>
<span class="line"><span style="color:#B392F0">        sudo</span><span style="color:#9ECBFF"> apt-get</span><span style="color:#9ECBFF"> install</span><span style="color:#79B8FF"> -y</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        initial_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"apt"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Initial source: </span><span style="color:#E1E4E8">$initial_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # PHASE 2: Perform migration (apt to snap or vice versa)</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "PHASE 2: Performing migration"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    target_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">""</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$initial_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "apt"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">        target_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"snap"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#E1E4E8">        target_source</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"apt"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Target source: </span><span style="color:#E1E4E8">$target_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Execute migration</span></span>
<span class="line"><span style="color:#E1E4E8">    migration_id</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"integration-test-$(</span><span style="color:#B392F0">date</span><span style="color:#9ECBFF"> +%s)"</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">capture_pre_migration_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> remove_package_completely</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$initial_source</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                                   "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Removal failed"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> install_from_new_source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$target_source</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                                 "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Installation failed, rolling back"</span></span>
<span class="line"><span style="color:#B392F0">        rollback_migration</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # PHASE 3: Verification</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "PHASE 3: Verification"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    post_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    post_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$post_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$post_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$target_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "Migration successful: </span><span style="color:#E1E4E8">$initial_source</span><span style="color:#9ECBFF"> → </span><span style="color:#E1E4E8">$target_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Migration failed: expected </span><span style="color:#E1E4E8">$target_source</span><span style="color:#9ECBFF">, got </span><span style="color:#E1E4E8">$post_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # PHASE 4: Rollback test</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "PHASE 4: Testing rollback"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    rollback_migration</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    rollback_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$TEST_PACKAGE</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    rollback_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$rollback_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$rollback_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$initial_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_success</span><span style="color:#9ECBFF"> "Rollback successful: restored to </span><span style="color:#E1E4E8">$initial_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Rollback verification failed"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # PHASE 5: Cleanup</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "PHASE 5: Cleanup"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Migration artifacts: </span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Test complete"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Run integration test</span></span>
<span class="line"><span style="color:#B392F0">integration_test_complete_migration</span></span></code></pre>
<hr>
<h2 id="7-integration-plan">7. Integration Plan</h2>
<h3 id="71-integration-with-existing-scripts">7.1 Integration with Existing Scripts</h3>
<h4 id="daily-updates-integration">Daily Updates Integration</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Add to scripts/daily-updates.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Source package migration library</span></span>
<span class="line"><span style="color:#79B8FF">source</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">SCRIPT_DIR</span><span style="color:#9ECBFF">}/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">verify_package_sources</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log_section</span><span style="color:#9ECBFF"> "Package Source Verification"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Key packages to verify</span></span>
<span class="line"><span style="color:#F97583">    declare</span><span style="color:#79B8FF"> -a</span><span style="color:#E1E4E8"> PACKAGES</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"gh"</span><span style="color:#9ECBFF"> "jq"</span><span style="color:#9ECBFF"> "curl"</span><span style="color:#9ECBFF"> "git"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> package </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">PACKAGES</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#B392F0">        log_info</span><span style="color:#9ECBFF"> "Verifying: </span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        current_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        preferred_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">decide_preferred_source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> !=</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            log_warning</span><span style="color:#9ECBFF"> "  Suboptimal source: </span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF"> (prefer: </span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            # Optionally auto-migrate with confirmation</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"${</span><span style="color:#E1E4E8">AUTO_MIGRATE</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">false</span><span style="color:#9ECBFF">}"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_info</span><span style="color:#9ECBFF"> "  Auto-migrating to </span><span style="color:#E1E4E8">$preferred_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">                migrate_package</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">            else</span></span>
<span class="line"><span style="color:#B392F0">                log_info</span><span style="color:#9ECBFF"> "  Run 'migrate_package </span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">' to optimize"</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#F97583">        else</span></span>
<span class="line"><span style="color:#B392F0">            log_success</span><span style="color:#9ECBFF"> "  Optimal source: </span><span style="color:#E1E4E8">$current_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Add to update workflow</span></span>
<span class="line"><span style="color:#B392F0">verify_package_sources</span></span></code></pre>
<h4 id="health-check-integration">Health Check Integration</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Add to .runners-local/workflows/health-check.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">check_package_management</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    log</span><span style="color:#9ECBFF"> "STEP"</span><span style="color:#9ECBFF"> "🔧 Checking package management"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Verify key tools are from optimal sources</span></span>
<span class="line"><span style="color:#79B8FF">    source</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">SCRIPT_DIR</span><span style="color:#9ECBFF">}/../../scripts/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # GitHub CLI</span></span>
<span class="line"><span style="color:#E1E4E8">    gh_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    gh_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$gh_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    gh_preferred</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">decide_preferred_source</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$gh_state</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$gh_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$gh_preferred</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        record_check</span><span style="color:#9ECBFF"> "package_management"</span><span style="color:#9ECBFF"> "gh_source"</span><span style="color:#9ECBFF"> "passed"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                    "optimal source: </span><span style="color:#E1E4E8">$gh_source</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">        log</span><span style="color:#9ECBFF"> "SUCCESS"</span><span style="color:#9ECBFF"> "✅ GitHub CLI: optimal source (</span><span style="color:#E1E4E8">$gh_source</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#B392F0">        record_check</span><span style="color:#9ECBFF"> "package_management"</span><span style="color:#9ECBFF"> "gh_source"</span><span style="color:#9ECBFF"> "warning"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                    "suboptimal: </span><span style="color:#E1E4E8">$gh_source</span><span style="color:#9ECBFF"> (prefer: </span><span style="color:#E1E4E8">$gh_preferred</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#B392F0">        log</span><span style="color:#9ECBFF"> "WARNING"</span><span style="color:#9ECBFF"> "⚠️  GitHub CLI: suboptimal source"</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Node.js (must be fnm)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> node</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">        node_path</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> node</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$node_path</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "fnm"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            record_check</span><span style="color:#9ECBFF"> "package_management"</span><span style="color:#9ECBFF"> "nodejs_fnm"</span><span style="color:#9ECBFF"> "passed"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                        "managed via fnm"</span></span>
<span class="line"><span style="color:#B392F0">            log</span><span style="color:#9ECBFF"> "SUCCESS"</span><span style="color:#9ECBFF"> "✅ Node.js: managed via fnm"</span></span>
<span class="line"><span style="color:#F97583">        else</span></span>
<span class="line"><span style="color:#B392F0">            record_check</span><span style="color:#9ECBFF"> "package_management"</span><span style="color:#9ECBFF"> "nodejs_fnm"</span><span style="color:#9ECBFF"> "failed"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">                        "not managed via fnm (violates CLAUDE.md)"</span></span>
<span class="line"><span style="color:#B392F0">            log</span><span style="color:#9ECBFF"> "ERROR"</span><span style="color:#9ECBFF"> "❌ Node.js: not managed via fnm"</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Add to health check sequence</span></span>
<span class="line"><span style="color:#B392F0">check_package_management</span></span></code></pre>
<h3 id="72-constitutional-compliance-integration">7.2 Constitutional Compliance Integration</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Add to .runners-local/workflows/constitutional-compliance-check.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">check_package_management_compliance</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "=== Package Management Compliance ==="</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    source</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">REPO_ROOT</span><span style="color:#9ECBFF">}/scripts/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Rule: Node.js must be managed via fnm</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> node</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">        node_path</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> node</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$node_path</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "fnm"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "✅ Node.js managed via fnm (CLAUDE.md compliant)"</span></span>
<span class="line"><span style="color:#F97583">        else</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "❌ VIOLATION: Node.js not managed via fnm"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "   Required by: CLAUDE.md section 'Package Management &#x26; Dependencies'"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "   Action: Remove apt/snap Node.js and install via fnm"</span></span>
<span class="line"><span style="color:#E1E4E8">            VIOLATIONS</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">VIOLATIONS</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Rule: GitHub CLI should use official source</span></span>
<span class="line"><span style="color:#E1E4E8">    gh_state</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "gh"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    gh_source</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$gh_state</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$gh_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "apt"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#6A737D">        # Check if official repository</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#B392F0"> apt-cache</span><span style="color:#9ECBFF"> policy</span><span style="color:#9ECBFF"> gh</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "cli.github.com"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "✅ GitHub CLI from official apt repository"</span></span>
<span class="line"><span style="color:#F97583">        else</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "⚠️  WARNING: GitHub CLI from Ubuntu repository (may be outdated)"</span></span>
<span class="line"><span style="color:#79B8FF">            echo</span><span style="color:#9ECBFF"> "   Recommendation: Add official GitHub CLI repository"</span></span>
<span class="line"><span style="color:#E1E4E8">            WARNINGS</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$((</span><span style="color:#B392F0">WARNINGS</span><span style="color:#9ECBFF"> +</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Add to compliance check workflow</span></span>
<span class="line"><span style="color:#B392F0">check_package_management_compliance</span></span></code></pre>
<h3 id="73-new-script-package-management-cli">7.3 New Script: Package Management CLI</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D"># scripts/manage-packages.sh</span></span>
<span class="line"><span style="color:#6A737D"># CLI tool for package management operations</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">set</span><span style="color:#79B8FF"> -euo</span><span style="color:#9ECBFF"> pipefail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">SCRIPT_DIR</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"$(</span><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> "$(</span><span style="color:#B392F0">dirname</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">BASH_SOURCE</span><span style="color:#9ECBFF">[0]}")" &#x26;&#x26; </span><span style="color:#79B8FF">pwd</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#79B8FF">source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$SCRIPT_DIR</span><span style="color:#9ECBFF">/package_migration_lib.sh"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">show_help</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#9ECBFF">Package Management Tool</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Usage: </span><span style="color:#79B8FF">$0</span><span style="color:#9ECBFF"> &#x3C;command> [options]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Commands:</span></span>
<span class="line"><span style="color:#9ECBFF">  verify &#x3C;package>       Show current state and recommendations</span></span>
<span class="line"><span style="color:#9ECBFF">  migrate &#x3C;package>      Migrate package to optimal source</span></span>
<span class="line"><span style="color:#9ECBFF">  verify-all            Verify all key packages</span></span>
<span class="line"><span style="color:#9ECBFF">  audit                 Generate audit report</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Options:</span></span>
<span class="line"><span style="color:#9ECBFF">  --force               Force migration even if same source</span></span>
<span class="line"><span style="color:#9ECBFF">  --dry-run             Show what would be done</span></span>
<span class="line"><span style="color:#9ECBFF">  --json                Output in JSON format</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">Examples:</span></span>
<span class="line"><span style="color:#79B8FF">  $0</span><span style="color:#9ECBFF"> verify gh</span></span>
<span class="line"><span style="color:#79B8FF">  $0</span><span style="color:#9ECBFF"> migrate gh</span></span>
<span class="line"><span style="color:#79B8FF">  $0</span><span style="color:#9ECBFF"> verify-all</span></span>
<span class="line"><span style="color:#79B8FF">  $0</span><span style="color:#9ECBFF"> audit --json > audit-report.json</span></span>
<span class="line"><span style="color:#9ECBFF">EOF</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">cmd_verify</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"${</span><span style="color:#E1E4E8">JSON_OUTPUT</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">false</span><span style="color:#9ECBFF">}"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Human-readable output</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Package: </span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Current Installation:"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Source: $(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">" </span><span style="color:#F97583">|</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installation_source')"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Version: $(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">" </span><span style="color:#F97583">|</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.installed_version')"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  Path: $(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">" </span><span style="color:#F97583">|</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.current_installation.binary_path')"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Available Sources:"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  apt: $(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">" </span><span style="color:#F97583">|</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.apt.candidate // "not available"')"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  snap: $(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">" </span><span style="color:#F97583">|</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.snap.stable_version // "not available"')"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  upstream: $(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">" </span><span style="color:#F97583">|</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.upstream.latest_version // "unknown"')"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Recommended Source:"</span></span>
<span class="line"><span style="color:#E1E4E8">    preferred</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">decide_preferred_source</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "  </span><span style="color:#E1E4E8">$preferred</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">cmd_migrate</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    force</span><span style="color:#F97583">=</span><span style="color:#FFAB70">${2</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">false</span><span style="color:#FFAB70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    migrate_package</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$force</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">cmd_verify_all</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#79B8FF">    declare</span><span style="color:#79B8FF"> -a</span><span style="color:#9ECBFF"> KEY_PACKAGES=</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">"gh"</span><span style="color:#9ECBFF"> "git"</span><span style="color:#9ECBFF"> "curl"</span><span style="color:#9ECBFF"> "jq"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Key Package Verification"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "========================"</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> package </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">KEY_PACKAGES</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#B392F0">        cmd_verify</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">cmd_audit</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    audit_timestamp</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">date</span><span style="color:#79B8FF"> -Iseconds</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    audit_report</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"/tmp/package-audit-$(</span><span style="color:#B392F0">date</span><span style="color:#9ECBFF"> +%s).json"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    declare</span><span style="color:#79B8FF"> -a</span><span style="color:#E1E4E8"> KEY_PACKAGES</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"gh"</span><span style="color:#9ECBFF"> "git"</span><span style="color:#9ECBFF"> "curl"</span><span style="color:#9ECBFF"> "jq"</span><span style="color:#9ECBFF"> "node"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    audit_data</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"["</span></span>
<span class="line"><span style="color:#E1E4E8">    first</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> package </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">KEY_PACKAGES</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$first</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "false"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">            audit_data</span><span style="color:#F97583">+=</span><span style="color:#9ECBFF">","</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#E1E4E8">        first</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        state_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">get_package_full_state</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> ||</span><span style="color:#79B8FF"> echo</span><span style="color:#9ECBFF"> '{}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        audit_data</span><span style="color:#F97583">+=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$state_json</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    audit_data</span><span style="color:#F97583">+=</span><span style="color:#9ECBFF">"]"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Wrap in audit report structure</span></span>
<span class="line"><span style="color:#E1E4E8">    audit_report_json</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$audit_data</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -n</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --arg</span><span style="color:#9ECBFF"> timestamp</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$audit_timestamp</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --arg</span><span style="color:#9ECBFF"> hostname</span><span style="color:#9ECBFF"> "$(</span><span style="color:#B392F0">hostname</span><span style="color:#9ECBFF">)"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --argjson</span><span style="color:#9ECBFF"> packages</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$audit_data</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">        '{</span></span>
<span class="line"><span style="color:#9ECBFF">            audit_timestamp: $timestamp,</span></span>
<span class="line"><span style="color:#9ECBFF">            hostname: $hostname,</span></span>
<span class="line"><span style="color:#9ECBFF">            packages: $packages</span></span>
<span class="line"><span style="color:#9ECBFF">        }'</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"${</span><span style="color:#E1E4E8">JSON_OUTPUT</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">false</span><span style="color:#9ECBFF">}"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "true"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$audit_report_json</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    else</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$audit_report_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$audit_report</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "Audit report generated: </span><span style="color:#E1E4E8">$audit_report</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # Show summary</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> ""</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "Summary:"</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$audit_report_json</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> jq</span><span style="color:#79B8FF"> -r</span><span style="color:#9ECBFF"> '.packages[] |</span></span>
<span class="line"><span style="color:#9ECBFF">            "  \(.package_name): \(.current_installation.installation_source) \(.current_installation.installed_version)"'</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Parse arguments</span></span>
<span class="line"><span style="color:#E1E4E8">COMMAND</span><span style="color:#F97583">=</span><span style="color:#FFAB70">${1</span><span style="color:#F97583">:-</span><span style="color:#E1E4E8">help</span><span style="color:#FFAB70">}</span></span>
<span class="line"><span style="color:#79B8FF">shift</span><span style="color:#F97583"> ||</span><span style="color:#79B8FF"> true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$COMMAND</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">    verify</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#B392F0">        cmd_verify</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$@</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        ;;</span></span>
<span class="line"><span style="color:#DBEDFF">    migrate</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#B392F0">        cmd_migrate</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">$@</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">        ;;</span></span>
<span class="line"><span style="color:#DBEDFF">    verify-all</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#B392F0">        cmd_verify_all</span></span>
<span class="line"><span style="color:#E1E4E8">        ;;</span></span>
<span class="line"><span style="color:#DBEDFF">    audit</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#B392F0">        cmd_audit</span></span>
<span class="line"><span style="color:#E1E4E8">        ;;</span></span>
<span class="line"><span style="color:#DBEDFF">    help</span><span style="color:#F97583">|</span><span style="color:#DBEDFF">--help</span><span style="color:#F97583">|</span><span style="color:#DBEDFF">-h</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#B392F0">        show_help</span></span>
<span class="line"><span style="color:#E1E4E8">        ;;</span></span>
<span class="line"><span style="color:#F97583">    *)</span></span>
<span class="line"><span style="color:#79B8FF">        echo</span><span style="color:#9ECBFF"> "Unknown command: </span><span style="color:#E1E4E8">$COMMAND</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">        show_help</span></span>
<span class="line"><span style="color:#79B8FF">        exit</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">        ;;</span></span>
<span class="line"><span style="color:#F97583">esac</span></span></code></pre>
<hr>
<h2 id="8-logging-and-audit-requirements">8. Logging and Audit Requirements</h2>
<h3 id="81-log-structure">8.1 Log Structure</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Logging Directory Structure:</span></span>
<span class="line"><span>/tmp/package-migration-logs/</span></span>
<span class="line"><span>├── migrations/</span></span>
<span class="line"><span>│   ├── YYYYMMDD-HHMMSS-package-pid/</span></span>
<span class="line"><span>│   │   ├── pre_state.json</span></span>
<span class="line"><span>│   │   ├── post_state.json</span></span>
<span class="line"><span>│   │   ├── metadata.json</span></span>
<span class="line"><span>│   │   ├── removal_log.txt</span></span>
<span class="line"><span>│   │   ├── installation_log.txt</span></span>
<span class="line"><span>│   │   ├── verification_log.txt</span></span>
<span class="line"><span>│   │   ├── migration_summary.json</span></span>
<span class="line"><span>│   │   └── MIGRATION_SUMMARY.txt</span></span>
<span class="line"><span>│   └── ...</span></span>
<span class="line"><span>├── decisions/</span></span>
<span class="line"><span>│   ├── YYYYMMDD-decisions.json</span></span>
<span class="line"><span>│   └── ...</span></span>
<span class="line"><span>├── comparisons/</span></span>
<span class="line"><span>│   ├── YYYYMMDD-comparisons.json</span></span>
<span class="line"><span>│   └── ...</span></span>
<span class="line"><span>└── audits/</span></span>
<span class="line"><span>    ├── YYYYMMDD-audit-report.json</span></span>
<span class="line"><span>    └── ...</span></span></code></pre>
<h3 id="82-json-schema-for-state-objects">8.2 JSON Schema for State Objects</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "package_state"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">    "timestamp"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"ISO8601"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "package_name"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "binary_name"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    "current_installation"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">      "installed"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"boolean"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "binary_path"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "installation_source"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"apt|snap|source|unknown"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "installed_version"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "binary_version"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#79B8FF">    "apt"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">      "available"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"boolean"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "source"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"apt"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "installed"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string|none"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "candidate"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "all_versions"</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#79B8FF">      "repository_info"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#79B8FF">    "snap"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">      "available"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"boolean"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "source"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"snap"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "installed"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "stable_version"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "publisher"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "publisher_verified"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"boolean"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "confinement"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"classic|strict|devmode"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "channels"</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#79B8FF">    "upstream"</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#79B8FF">      "source"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "latest_version"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">      "url"</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"string"</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="9-performance-considerations">9. Performance Considerations</h2>
<h3 id="91-caching-strategy">9.1 Caching Strategy</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Cache package queries to avoid repeated apt-cache/snap info calls</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">CACHE_DIR</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"/tmp/package-query-cache"</span></span>
<span class="line"><span style="color:#E1E4E8">CACHE_TTL</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">300</span><span style="color:#6A737D">  # 5 minutes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">get_cached_query</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    query_type</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cache_file</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$CACHE_DIR</span><span style="color:#9ECBFF">/${</span><span style="color:#E1E4E8">query_type</span><span style="color:#9ECBFF">}_${</span><span style="color:#E1E4E8">package_name</span><span style="color:#9ECBFF">}.json"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if cache exists and is fresh</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$cache_file</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#E1E4E8">        cache_age</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(($(</span><span style="color:#B392F0">date</span><span style="color:#9ECBFF"> +%s</span><span style="color:#E1E4E8">) - $(</span><span style="color:#79B8FF">stat</span><span style="color:#79B8FF"> -c</span><span style="color:#9ECBFF"> %Y</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$cache_file</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ $cache_age </span><span style="color:#F97583">-lt</span><span style="color:#E1E4E8"> $CACHE_TTL ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">            cat</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$cache_file</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Cache miss or stale</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">set_cached_query</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    query_type</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"><span style="color:#E1E4E8">    data</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    mkdir</span><span style="color:#79B8FF"> -p</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$CACHE_DIR</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">    cache_file</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$CACHE_DIR</span><span style="color:#9ECBFF">/${</span><span style="color:#E1E4E8">query_type</span><span style="color:#9ECBFF">}_${</span><span style="color:#E1E4E8">package_name</span><span style="color:#9ECBFF">}.json"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$data</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$cache_file</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="92-parallel-queries">9.2 Parallel Queries</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Query multiple sources in parallel for faster state retrieval</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">get_package_full_state_parallel</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Create temporary files for parallel results</span></span>
<span class="line"><span style="color:#E1E4E8">    tmp_dir</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">mktemp</span><span style="color:#79B8FF"> -d</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Launch queries in background</span></span>
<span class="line"><span style="color:#B392F0">    query_current_installation</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/current.json"</span><span style="color:#E1E4E8"> &#x26;</span></span>
<span class="line"><span style="color:#B392F0">    query_apt_package_info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/apt.json"</span><span style="color:#E1E4E8"> &#x26;</span></span>
<span class="line"><span style="color:#B392F0">    query_snap_package_info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/snap.json"</span><span style="color:#E1E4E8"> &#x26;</span></span>
<span class="line"><span style="color:#B392F0">    query_upstream_latest</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/upstream.json"</span><span style="color:#E1E4E8"> &#x26;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Wait for all to complete</span></span>
<span class="line"><span style="color:#79B8FF">    wait</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Combine results</span></span>
<span class="line"><span style="color:#B392F0">    jq</span><span style="color:#79B8FF"> -n</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --slurpfile</span><span style="color:#9ECBFF"> current</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/current.json"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --slurpfile</span><span style="color:#9ECBFF"> apt</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/apt.json"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --slurpfile</span><span style="color:#9ECBFF"> snap</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/snap.json"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --slurpfile</span><span style="color:#9ECBFF"> upstream</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">/upstream.json"</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">        '{</span></span>
<span class="line"><span style="color:#9ECBFF">            timestamp: now | todate,</span></span>
<span class="line"><span style="color:#9ECBFF">            package_name: $ARGS.positional[0],</span></span>
<span class="line"><span style="color:#9ECBFF">            current_installation: $current[0],</span></span>
<span class="line"><span style="color:#9ECBFF">            apt: $apt[0],</span></span>
<span class="line"><span style="color:#9ECBFF">            snap: $snap[0],</span></span>
<span class="line"><span style="color:#9ECBFF">            upstream: $upstream[0]</span></span>
<span class="line"><span style="color:#9ECBFF">        }'</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">        --args</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Cleanup</span></span>
<span class="line"><span style="color:#B392F0">    rm</span><span style="color:#79B8FF"> -rf</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$tmp_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="10-security-considerations">10. Security Considerations</h2>
<h3 id="101-publisher-verification">10.1 Publisher Verification</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Strict publisher verification for snaps</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">VERIFIED_PUBLISHERS</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">    "ken-vandine"</span><span style="color:#6A737D">     # Ghostty official</span></span>
<span class="line"><span style="color:#9ECBFF">    "GitHub"</span><span style="color:#6A737D">          # GitHub CLI</span></span>
<span class="line"><span style="color:#9ECBFF">    "iojs"</span><span style="color:#6A737D">            # Node.js official</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">verify_snap_publisher_strict</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    snap_info</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">snap</span><span style="color:#9ECBFF"> info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    publisher</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">echo</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$snap_info</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> "publisher:"</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> awk</span><span style="color:#9ECBFF"> '{print $2}'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> verified </span><span style="color:#F97583">in</span><span style="color:#9ECBFF"> "${</span><span style="color:#E1E4E8">VERIFIED_PUBLISHERS</span><span style="color:#9ECBFF">[</span><span style="color:#F97583">@</span><span style="color:#9ECBFF">]}"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">do</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">$publisher</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ==</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$verified</span><span style="color:#9ECBFF">"</span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">        fi</span></span>
<span class="line"><span style="color:#F97583">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    log_error</span><span style="color:#9ECBFF"> "Publisher not in verified list: </span><span style="color:#E1E4E8">$publisher</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="102-integrity-verification">10.2 Integrity Verification</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Verify package integrity after installation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">verify_package_integrity</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    installation_source</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$installation_source</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        apt</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Use apt to verify package integrity</span></span>
<span class="line"><span style="color:#B392F0">            dpkg</span><span style="color:#79B8FF"> --verify</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                grep</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> "^???"</span><span style="color:#F97583"> ||</span><span style="color:#F97583"> return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        snap</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#6A737D">            # Snap has built-in integrity checks</span></span>
<span class="line"><span style="color:#B392F0">            snap</span><span style="color:#9ECBFF"> info</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF"> --verbose</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#B392F0">                grep</span><span style="color:#79B8FF"> -q</span><span style="color:#9ECBFF"> "base-snap-verified: true"</span><span style="color:#F97583"> ||</span><span style="color:#F97583"> return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<hr>
<h2 id="11-rollback-safeguards">11. Rollback Safeguards</h2>
<h3 id="111-automatic-rollback-triggers">11.1 Automatic Rollback Triggers</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Define conditions that trigger automatic rollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">should_trigger_rollback</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    package_name</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if binary is accessible</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#79B8FF"> command</span><span style="color:#79B8FF"> -v</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Rollback trigger: binary not accessible"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check if version can be determined</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> get_version_from_binary</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">        log_error</span><span style="color:#9ECBFF"> "Rollback trigger: version check failed"</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">    fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Check basic functionality</span></span>
<span class="line"><span style="color:#F97583">    case</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> in</span></span>
<span class="line"><span style="color:#DBEDFF">        gh</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> gh</span><span style="color:#79B8FF"> --version</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_error</span><span style="color:#9ECBFF"> "Rollback trigger: gh functionality check failed"</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#DBEDFF">        node</span><span style="color:#F97583">)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#F97583"> !</span><span style="color:#B392F0"> node</span><span style="color:#79B8FF"> -e</span><span style="color:#9ECBFF"> "console.log('test')"</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">/dev/null</span><span style="color:#F97583"> 2>&#x26;1</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">                log_error</span><span style="color:#9ECBFF"> "Rollback trigger: node functionality check failed"</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">            fi</span></span>
<span class="line"><span style="color:#E1E4E8">            ;;</span></span>
<span class="line"><span style="color:#F97583">    esac</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # No rollback triggers</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Integrate into migration workflow</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#B392F0"> should_trigger_rollback</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">    log_warning</span><span style="color:#9ECBFF"> "Automatic rollback triggered"</span></span>
<span class="line"><span style="color:#B392F0">    rollback_migration</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$package_name</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$migration_id</span><span style="color:#9ECBFF">"</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">fi</span></span></code></pre>
<hr>
<h2 id="12-documentation-requirements">12. Documentation Requirements</h2>
<h3 id="121-migration-report-template">12.1 Migration Report Template</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">generate_migration_report</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    state_dir</span><span style="color:#F97583">=</span><span style="color:#FFAB70">$1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    cat</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$state_dir</span><span style="color:#9ECBFF">/MIGRATION_REPORT.md"</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#9ECBFF">'EOF'</span></span>
<span class="line"><span style="color:#9ECBFF"># Package Migration Report</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">## Migration Information</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">- **Migration ID**: {{migration_id}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **Package**: {{package_name}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **Date**: {{date}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **Hostname**: {{hostname}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **User**: {{user}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">## Before Migration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">- **Source**: {{before_source}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **Version**: {{before_version}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **Binary Path**: {{before_path}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">## After Migration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">- **Source**: {{after_source}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **Version**: {{after_version}}</span></span>
<span class="line"><span style="color:#9ECBFF">- **Binary Path**: {{after_path}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">## Decision Reasoning</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">{{decision_reasoning}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">## Verification Results</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">### Removal Verification</span></span>
<span class="line"><span style="color:#9ECBFF">{{removal_verification}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">### Installation Verification</span></span>
<span class="line"><span style="color:#9ECBFF">{{installation_verification}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">### Functionality Check</span></span>
<span class="line"><span style="color:#9ECBFF">{{functionality_check}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">## Files and Logs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">- Pre-state: `pre_state.json`</span></span>
<span class="line"><span style="color:#9ECBFF">- Post-state: `post_state.json`</span></span>
<span class="line"><span style="color:#9ECBFF">- Removal log: `removal_log.txt`</span></span>
<span class="line"><span style="color:#9ECBFF">- Installation log: `installation_log.txt`</span></span>
<span class="line"><span style="color:#9ECBFF">- Verification log: `verification_log.txt`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">## Rollback Information</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">To rollback this migration:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">```bash</span></span>
<span class="line"><span style="color:#9ECBFF">./scripts/manage-packages.sh rollback {{migration_id}}</span></span></code></pre>
<p>Or manually:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># Remove current installation</span></span>
<span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> {{remove_command}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Restore previous installation</span></span>
<span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> {{restore_command}}</span></span></code></pre>
<hr>
<p><em>This report was automatically generated by the package migration system.</em>
EOF</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># Replace placeholders with actual values</span></span>
<span class="line"><span># (Implementation would use sed or jq to fill in values)</span></span></code></pre>
<p>}</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span></span></span>
<span class="line"><span>---</span></span>
<span class="line"><span></span></span>
<span class="line"><span>## Conclusion</span></span>
<span class="line"><span></span></span>
<span class="line"><span>This design provides a comprehensive, audit-ready package management verification and migration system that:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. **Never assumes**: Always queries actual system state</span></span>
<span class="line"><span>2. **Transparent**: Every decision is logged with reasoning</span></span>
<span class="line"><span>3. **Safe**: Complete state capture, verification, and rollback capability</span></span>
<span class="line"><span>4. **Constitutional**: Follows CLAUDE.md requirements explicitly</span></span>
<span class="line"><span>5. **Extensible**: Easy to add new packages and sources</span></span>
<span class="line"><span>6. **Testable**: Comprehensive test suite with integration tests</span></span>
<span class="line"><span>7. **Integrated**: Works with existing scripts and workflows</span></span>
<span class="line"><span></span></span>
<span class="line"><span>The system is ready for implementation as a reusable bash module that can be integrated into the ghostty-config-files repository's CI/CD and update workflows.</span></span></code></pre> <div class="mt-12"> <div class="divider"></div> <div class="flex gap-2 flex-wrap"> <span class="badge badge-outline">developer</span><span class="badge badge-outline">technical</span> </div> </div> </article> </main> <!-- Modern Glass Footer --> <footer class="footer footer-center bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl text-gray-900 dark:text-gray-100 p-10 mt-16 border-t border-gray-200/50 dark:border-gray-700/50"> <aside> <p class="font-bold text-xl mb-2">
Ghostty Configuration Files
</p> <p class="max-w-2xl text-gray-600 dark:text-gray-400">
A comprehensive terminal environment setup featuring Ghostty terminal emulator<br>
with 2025 performance optimizations, AI tools integration, and intelligent update management.
</p> <p class="text-sm text-gray-600 dark:text-gray-400 mt-4">
Built with Astro v5 + Tailwind CSS v4 + DaisyUI v5
</p> </aside> </footer>  </body> </html>