# ZSH Security Check Integration
#
# This file documents the .zshrc integration for automatic ZSH compinit
# security checking. These lines should be added to ~/.zshrc for full
# functionality of the zsh-security-check system.
#
# Installation: The start.sh script or zsh.sh module should append these
# configurations to the user's ~/.zshrc file.

# ============================================================================
# Automatic ZSH compinit security fix
# Location: Near top of .zshrc, after ZSH variable, before instant prompt
# ============================================================================

# Check and fix insecure completion files automatically (runs once per day)
if [[ -f "$HOME/Apps/ghostty-config-files/scripts/fix-zsh-compinit-security.sh" ]]; then
    local last_check_file="/tmp/.zsh-security-check-$(date +%Y%m%d)"
    if [[ ! -f "$last_check_file" ]]; then
        # Run check silently - if issues found, auto-fix with sudo
        if ! "$HOME/Apps/ghostty-config-files/scripts/fix-zsh-compinit-security.sh" --check &>/dev/null; then
            echo "âš ï¸  ZSH security check: Insecure completion files detected"
            echo "ðŸ”§ Auto-fixing with sudo (you may be prompted for password)..."
            "$HOME/Apps/ghostty-config-files/scripts/fix-zsh-compinit-security.sh" --auto 2>&1 | grep -E '(SUCCESS|ERROR|WARNING)' || true
            touch "$last_check_file"
        else
            touch "$last_check_file"
        fi
    fi
fi

# Disable insecure directory check for vendor completions (must be before Oh My Zsh loads)
ZSH_DISABLE_COMPFIX=true

# ============================================================================
# ZSH Security Check System - Manual Commands
# Location: Near other aliases (after Oh My Zsh loads)
# ============================================================================

# Alias for manual zsh security checks
alias zsh-check-security='/home/kkk/Apps/ghostty-config-files/scripts/fix-zsh-compinit-security.sh --check'
alias zsh-fix-security='/home/kkk/Apps/ghostty-config-files/scripts/fix-zsh-compinit-security.sh'

# ============================================================================
# Enhanced compinit configuration (skip security checks)
# Location: After Oh My Zsh loads, in performance optimization section
# ============================================================================

# Compilation caching for faster startup
autoload -Uz compinit
if [ "$(date +'%j')" != "$(date -r ~/.zcompdump +"%j" 2>/dev/null)" ]; then
    compinit -u
else
    compinit -C -u
fi
