name: Build Feature Branches

# Build workflow for feature branches
# Validates Astro build and TypeScript compilation
# Triggers on push to feature/* and fix/* branches
# No deployment - validation only

on:
  push:
    branches: ['feature/**', 'fix/**']
    paths:
      - 'astro-website/**'
      - 'configs/**'
      - '.github/workflows/build-feature-branches.yml'
  pull_request:
    branches: [main]
    paths:
      - 'astro-website/**'
      - 'configs/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write

env:
  NODE_ENV: production
  ASTRO_TELEMETRY_DISABLED: 1
  NPM_CONFIG_PROGRESS: false
  NPM_CONFIG_AUDIT: false

jobs:
  # Astro build validation
  build-astro:
    name: Build Astro Site
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          cache: 'npm'
          cache-dependency-path: 'astro-website/package-lock.json'

      - name: Install dependencies
        working-directory: ./astro-website
        run: |
          echo "Installing npm dependencies..."
          npm ci --silent

      - name: List installed versions
        working-directory: ./astro-website
        run: |
          echo "Dependency versions:"
          npm list astro --depth=0 || true
          npm list typescript --depth=0 || true
          npm list @astrojs/check --depth=0 || true

      - name: Run TypeScript check
        working-directory: ./astro-website
        run: |
          echo "Running TypeScript validation..."
          npm run check

      - name: Build Astro site
        working-directory: ./astro-website
        run: |
          echo "Building Astro documentation site..."
          npm run build

      - name: Verify build artifacts
        run: |
          echo "Verifying build output..."

          # Check index.html
          if [ ! -f "docs/index.html" ]; then
            echo "ERROR: docs/index.html not found after build"
            exit 1
          fi
          echo "✓ index.html created"

          # Check _astro assets
          if [ ! -d "docs/_astro" ]; then
            echo "ERROR: docs/_astro directory not found"
            exit 1
          fi

          ASSET_COUNT=$(find docs/_astro -type f | wc -l)
          echo "✓ Build artifacts verified: $ASSET_COUNT asset files"

          # Size metrics
          BUILD_SIZE=$(du -sh docs/ | cut -f1)
          FILE_COUNT=$(find docs/ -type f | wc -l)
          echo "Build size: $BUILD_SIZE ($FILE_COUNT files)"

      - name: Check .nojekyll preservation
        run: |
          echo "Verifying .nojekyll file..."
          if [ ! -f "docs/.nojekyll" ]; then
            echo "ERROR: .nojekyll file missing after build"
            exit 1
          fi
          echo "✓ .nojekyll file present and intact"

  # Dry-run deployment check
  deployment-check:
    name: Deployment Readiness Check
    needs: build-astro
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Pages configuration
        run: |
          echo "Checking GitHub Pages configuration..."

          # Check for pages config file (if using custom domains)
          if [ -f "docs/CNAME" ]; then
            echo "✓ Custom domain configured"
            cat docs/CNAME
          fi

          # Verify build output directory
          if [ -d "docs" ]; then
            echo "✓ Deployment directory 'docs' exists"
            FILE_COUNT=$(find docs -type f | wc -l)
            echo "  Files ready for deployment: $FILE_COUNT"
          else
            echo "ERROR: Deployment directory not found"
            exit 1
          fi

      - name: Check GitHub Pages settings
        run: |
          echo "GitHub Pages deployment configuration:"
          echo "- Build directory: ./docs"
          echo "- Source: GitHub Actions"
          echo "- Branch: main"
          echo "- Critical file: .nojekyll (present)"

  # Code quality checks
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          cache: 'npm'
          cache-dependency-path: 'astro-website/package-lock.json'

      - name: Install dependencies
        working-directory: ./astro-website
        run: npm ci --silent

      - name: Check for TypeScript errors
        working-directory: ./astro-website
        run: |
          echo "Comprehensive TypeScript validation..."
          npm run check

      - name: Lint configuration files
        run: |
          echo "Linting Ghostty configuration..."

          CONFIG_FILE="configs/ghostty/config"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Configuration file not found"
            exit 1
          fi

          # Check for common issues
          echo "Checking for formatting issues..."

          # No leading/trailing spaces on config lines
          if grep -E "^\s+|:\s+$" "$CONFIG_FILE"; then
            echo "⚠ Warning: Potential formatting issues detected"
          fi

          echo "✓ Configuration lint completed"

      - name: Validate JSON files
        run: |
          echo "Validating JSON configuration files..."

          JSON_FILES=$(find . -maxdepth 3 -type f -name "*.json" ! -path "./website/node_modules/*" ! -path "./.git/*")

          if [ -z "$JSON_FILES" ]; then
            echo "No JSON files to validate"
            exit 0
          fi

          while IFS= read -r file; do
            echo "Validating: $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "ERROR: Invalid JSON in $file"
              exit 1
            fi
          done <<< "$JSON_FILES"

          echo "✓ All JSON files valid"

  # Build summary
  build-summary:
    name: Build Summary
    needs: [build-astro, deployment-check, code-quality]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report build status
        run: |
          echo "Build Summary for Feature Branch"
          echo "========================================"
          echo "✓ Astro Build: Completed"
          echo "✓ Deployment Readiness: Verified"
          echo "✓ Code Quality: Validated"
          echo "========================================"
          echo "Feature branch is ready for merge to main"
