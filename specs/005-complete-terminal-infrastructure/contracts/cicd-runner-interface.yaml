# Contract: CI/CD Runner Interface
# Feature: 005-complete-terminal-infrastructure
# Version: 1.0.0
# Created: 2025-11-16
#
# Purpose: Defines the interface for local GitHub Actions execution using nektos/act
#          with zero GitHub Actions consumption (constitutional requirement)

---
contract_id: cicd-runner-interface
contract_version: 1.0.0
description: |
  Interface for executing GitHub Actions workflows locally using nektos/act.
  Provides 100% fidelity to GitHub cloud environment while consuming zero
  GitHub Actions minutes.

---
## Core Requirements

requirements:
  zero_cost:
    description: "Constitutional requirement: Zero GitHub Actions minutes consumption"
    enforcement: All workflows MUST execute locally before any GitHub deployment
    violation: CONSTITUTIONAL VIOLATION - immediate rollback required

  full_fidelity:
    description: Local execution must match GitHub cloud behavior exactly
    coverage:
      - Custom actions support
      - Matrix builds
      - Workflow dependencies
      - Reusable workflows
      - Composite actions
      - Environment secrets
      - Caching mechanisms

  tools:
    primary: nektos/act (v0.2.82+)
    fallback: null  # No fallback - act is mandatory
    docker: required  # act uses Docker containers

---
## Installation Requirements

installation:
  act:
    method: binary_download  # Preferred: Direct binary
    alternative: package_manager  # apt/snap if available
    version: ">=0.2.82"
    verification: act --version
    location: /usr/local/bin/act or ~/.local/bin/act

  docker:
    method: system_package
    version: ">=20.10.0"
    verification: docker version
    requirements:
      - Docker daemon running
      - User in docker group (no sudo required)
      - Docker socket accessible

  gh_cli:
    method: existing  # Already required by constitution
    version: ">=2.0.0"
    verification: gh --version
    purpose: Workflow file parsing and API access

---
## API Interface

functions:
  - name: init_local_runner
    description: Initialize local GitHub Actions runner environment
    parameters:
      - name: workflow_dir
        type: string
        required: true
        default: ".github/workflows"
        description: Path to workflows directory
      - name: runner_config
        type: object
        required: false
        description: Runner configuration overrides
    returns:
      type: object
      description: Runner environment info
    exit_codes:
      0: Runner initialized successfully
      1: act not installed
      2: Docker not running
      3: Workflow directory not found

  - name: list_workflows
    description: List all available workflows
    parameters:
      - name: workflow_dir
        type: string
        required: false
        default: ".github/workflows"
    returns:
      type: array[object]
      description: List of workflows with metadata
    exit_codes:
      0: Workflows listed successfully
      1: No workflows found

  - name: validate_workflow
    description: Validate workflow syntax and dependencies
    parameters:
      - name: workflow_file
        type: string
        required: true
        description: Path to workflow YAML file
    returns:
      type: object
      description: Validation results
    exit_codes:
      0: Workflow valid
      1: Syntax error
      2: Missing dependencies

  - name: run_workflow
    description: Execute workflow locally using act
    parameters:
      - name: workflow_name
        type: string
        required: true
        description: Workflow name or file path
      - name: event
        type: string
        required: false
        default: "push"
        description: Trigger event (push, pull_request, etc.)
      - name: job
        type: string
        required: false
        description: Specific job to run (runs all if not specified)
      - name: env_vars
        type: object
        required: false
        description: Environment variables
      - name: secrets
        type: object
        required: false
        description: Secrets (from .env file)
      - name: dry_run
        type: boolean
        required: false
        default: false
        description: Show what would run without executing
    returns:
      type: object
      description: Workflow execution results
    exit_codes:
      0: Workflow succeeded
      1: Workflow failed
      2: Workflow cancelled
      78: act execution error

  - name: run_matrix_build
    description: Execute matrix build strategy locally
    parameters:
      - name: workflow_name
        type: string
        required: true
      - name: matrix_config
        type: object
        required: true
        description: Matrix configuration
    returns:
      type: object
      description: Matrix build results (all combinations)
    exit_codes:
      0: All matrix builds succeeded
      1: One or more builds failed

  - name: cleanup_runner
    description: Clean up runner resources
    parameters:
      - name: keep_containers
        type: boolean
        required: false
        default: false
        description: Keep Docker containers for inspection
      - name: keep_cache
        type: boolean
        required: false
        default: true
        description: Keep cached dependencies
    returns:
      type: boolean
    exit_codes:
      0: Cleanup successful

---
## Configuration

actrc_config:
  description: |
    .actrc file in repository root for act configuration
  location: /home/kkk/Apps/ghostty-config-files/.actrc
  format: |
    # Platform mappings (Docker images)
    -P ubuntu-latest=catthehacker/ubuntu:full-latest
    -P ubuntu-22.04=catthehacker/ubuntu:full-22.04
    -P ubuntu-20.04=catthehacker/ubuntu:full-20.04

    # Secrets file
    --secret-file .env

    # Bind mounts (access to repository files)
    --bind

    # Container architecture
    --container-architecture linux/amd64

    # Network mode
    --network host

  docker_images:
    full:
      name: catthehacker/ubuntu:full-latest
      size: ~12GB
      description: Full environment with all tools (closest to GitHub)
    runner:
      name: catthehacker/ubuntu:runner-latest
      size: ~2GB
      description: Lightweight runner with basic tools
    act:
      name: catthehacker/ubuntu:act-latest
      size: ~500MB
      description: Minimal act-specific image

secrets_config:
  description: Secrets loaded from .env file (gitignored)
  location: /home/kkk/Apps/ghostty-config-files/.env
  format: |
    # GitHub token (required for API access)
    GITHUB_TOKEN=ghp_xxxxxxxxxxxxx

    # Custom secrets
    NPM_TOKEN=npm_xxxxxxxxxxxxx
    ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxx

  validation:
    - GITHUB_TOKEN must be present
    - Secrets never committed to repository
    - .env file in .gitignore

environment_config:
  description: Environment variables for workflow execution
  sources:
    - .env file (secrets)
    - System environment
    - Workflow-specific env block
  precedence:
    1: Workflow-specific env (highest)
    2: .env file secrets
    3: System environment (lowest)

---
## Workflow Execution

execution_flow:
  1_parse_workflow:
    description: Parse .github/workflows/*.yml files
    tool: act or yq
    validation:
      - Valid YAML syntax
      - Required fields present (name, on, jobs)
      - No circular dependencies

  2_resolve_dependencies:
    description: Resolve job dependencies and execution order
    strategy: topological_sort
    example: |
      jobs:
        build:
          runs-on: ubuntu-latest
        test:
          needs: build  # Runs after build
        deploy:
          needs: [build, test]  # Runs after both

  3_setup_environment:
    description: Prepare Docker containers for execution
    steps:
      - Pull required Docker images
      - Create container network
      - Mount repository files
      - Inject secrets and env vars

  4_execute_jobs:
    description: Run jobs sequentially or in parallel
    parallel: Jobs without dependencies run in parallel
    sequential: Jobs with 'needs' run after dependencies
    isolation: Each job gets separate container

  5_collect_results:
    description: Gather workflow results
    outputs:
      - Exit codes for each job
      - Stdout/stderr logs
      - Generated artifacts
      - Performance metrics

  6_cleanup:
    description: Clean up Docker resources
    options:
      - Remove containers (default)
      - Keep containers for debugging (--rm=false)
      - Remove images (--pull=false to keep)

---
## Workflow Examples

example_simple_workflow:
  description: Basic CI workflow
  file: .github/workflows/ci.yml
  content: |
    name: CI

    on:
      push:
        branches: [main]
      pull_request:

    jobs:
      validate:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - name: Validate Ghostty config
            run: ghostty +show-config

      test:
        runs-on: ubuntu-latest
        needs: validate
        steps:
          - uses: actions/checkout@v4
          - name: Run tests
            run: ./.runners-local/tests/run_all_tests.sh

  execution: |
    # List jobs in workflow
    act -l -W .github/workflows/ci.yml

    # Run entire workflow
    act push -W .github/workflows/ci.yml

    # Run specific job
    act -j validate -W .github/workflows/ci.yml

    # Dry run
    act -n push

example_matrix_workflow:
  description: Matrix build across multiple configurations
  file: .github/workflows/matrix.yml
  content: |
    name: Matrix Build

    on: [push]

    jobs:
      build:
        runs-on: ubuntu-latest
        strategy:
          matrix:
            node-version: [18, 20, 22, latest]
            os: [ubuntu-22.04, ubuntu-24.04]
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
          - run: npm ci
          - run: npm test

  execution: |
    # Run all matrix combinations
    act push -W .github/workflows/matrix.yml

    # Results: 4 node versions Ã— 2 OS = 8 builds locally

example_reusable_workflow:
  description: Reusable workflow called from other workflows
  caller: .github/workflows/main.yml
  caller_content: |
    name: Main Workflow

    on: [push]

    jobs:
      call-reusable:
        uses: ./.github/workflows/reusable.yml
        with:
          environment: production

  reusable: .github/workflows/reusable.yml
  reusable_content: |
    name: Reusable Workflow

    on:
      workflow_call:
        inputs:
          environment:
            required: true
            type: string

    jobs:
      deploy:
        runs-on: ubuntu-latest
        steps:
          - run: echo "Deploying to ${{ inputs.environment }}"

  execution: |
    # act supports reusable workflows
    act push -W .github/workflows/main.yml

---
## Integration with manage.sh

manage_sh_commands:
  - command: ./manage.sh cicd validate
    description: Validate all workflows locally
    implementation: |
      for workflow in .github/workflows/*.yml; do
        act -l -W "$workflow" || exit 1
      done

  - command: ./manage.sh cicd run <workflow>
    description: Run specific workflow locally
    implementation: |
      act push -W ".github/workflows/$1.yml"

  - command: ./manage.sh cicd test
    description: Run all CI/CD tests locally
    implementation: |
      act push -W .github/workflows/ci.yml
      act pull_request -W .github/workflows/pr-checks.yml

  - command: ./manage.sh cicd matrix
    description: Test matrix builds locally
    implementation: |
      act push -W .github/workflows/matrix.yml

  - command: ./manage.sh cicd billing
    description: Verify zero GitHub Actions consumption
    implementation: |
      # Constitutional check: Ensure no minutes consumed
      minutes=$(gh api user/settings/billing/actions | jq '.total_minutes_used')
      baseline=0
      if [[ "$minutes" -ne "$baseline" ]]; then
        echo "WARNING: GitHub Actions minutes consumed: $minutes"
        echo "Expected: 0 (constitutional requirement)"
        exit 1
      fi

  - command: ./manage.sh cicd status
    description: Check workflow execution status
    implementation: |
      gh run list --limit 10 --json status,conclusion,name,createdAt

---
## Performance Monitoring

performance:
  metrics:
    - workflow_total_duration
    - job_execution_times
    - docker_image_pull_time
    - container_startup_time
    - test_execution_time

  targets:
    workflow_execution: <5 minutes for full CI
    container_startup: <30 seconds
    image_pull: <2 minutes (first time only, cached after)

  reporting:
    location: .runners-local/logs/cicd-performance-{timestamp}.json
    format: |
      {
        "workflow": "ci.yml",
        "event": "push",
        "start_time": "2025-11-16T10:30:00Z",
        "end_time": "2025-11-16T10:33:45Z",
        "total_duration": 225.3,
        "jobs": [
          {
            "job": "validate",
            "duration": 45.2,
            "status": "success"
          },
          {
            "job": "test",
            "duration": 180.1,
            "status": "success"
          }
        ],
        "minutes_consumed_github": 0
      }

---
## Error Handling

errors:
  docker_not_running:
    exit_code: 2
    message: "Docker daemon not running. Start with: sudo systemctl start docker"
    recovery: Start Docker service

  act_not_installed:
    exit_code: 1
    message: "act not found. Install with: curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | bash"
    recovery: Install act binary

  workflow_syntax_error:
    exit_code: 1
    message: "Workflow YAML syntax error at line {line}"
    recovery: Fix YAML syntax in workflow file

  workflow_failed:
    exit_code: 1
    message: "Workflow execution failed. Check logs at {log_path}"
    recovery: Review logs, fix issues, re-run

  secrets_missing:
    exit_code: 1
    message: "Required secret {secret_name} not found in .env"
    recovery: Add secret to .env file

  zero_cost_violation:
    exit_code: 99
    message: "CONSTITUTIONAL VIOLATION: GitHub Actions minutes consumed!"
    recovery: Immediate investigation required

---
## Testing Requirements

test_coverage:
  - name: test_act_installation
    description: Verify act is installed and accessible
  - name: test_docker_availability
    description: Verify Docker daemon is running
  - name: test_workflow_parsing
    description: Verify workflow files parse correctly
  - name: test_simple_workflow
    description: Execute simple workflow with one job
  - name: test_matrix_workflow
    description: Execute matrix workflow with multiple combinations
  - name: test_reusable_workflow
    description: Execute workflow calling reusable workflow
  - name: test_secrets_injection
    description: Verify secrets loaded from .env correctly
  - name: test_zero_cost
    description: Verify zero GitHub Actions minutes consumed
  - name: test_failure_handling
    description: Verify failures reported correctly
  - name: test_cleanup
    description: Verify Docker resources cleaned up properly

---
## Dependencies

required_binaries:
  - name: act
    version: ">=0.2.82"
    check: act --version
    install: curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | bash

  - name: docker
    version: ">=20.10.0"
    check: docker version
    install: System package manager

  - name: gh
    version: ">=2.0.0"
    check: gh --version
    install: Already required by constitution

required_files:
  - .actrc  # act configuration
  - .env    # Secrets (gitignored)
  - .github/workflows/*.yml  # Workflow files

required_env_vars:
  - GITHUB_TOKEN  # For gh CLI and act

---
## Constitutional Compliance

compliance:
  zero_cost_operations:
    requirement: All CI/CD must run locally before GitHub
    enforcement: manage.sh blocks GitHub operations if local validation fails
    monitoring: Weekly billing check via gh API

  branch_preservation:
    requirement: Never delete branches
    enforcement: Workflows cannot include branch deletion steps
    validation: Pre-flight check before workflow execution

  local_first_development:
    requirement: Local validation before remote deployment
    enforcement: CI/CD runs locally, only deploys if successful
    benefits: Zero cost, immediate feedback, full control

  latest_stable_versions:
    requirement: Use latest stable tool versions
    enforcement: Regular updates to act, Docker images, workflow actions
    tracking: Automated version checks in CI/CD

---
## Advanced Features

features:
  custom_actions:
    support: true
    description: Run custom GitHub Actions locally
    example: |
      # Custom action in .github/actions/my-action/action.yml
      runs:
        using: "composite"
        steps:
          - run: echo "Custom action executed"

      # Use in workflow
      steps:
        - uses: ./.github/actions/my-action

  caching:
    support: true
    description: Cache dependencies between runs
    example: |
      steps:
        - uses: actions/cache@v4
          with:
            path: ~/.npm
            key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      # act respects cache actions

  artifacts:
    support: true
    description: Upload and download artifacts
    example: |
      steps:
        - uses: actions/upload-artifact@v4
          with:
            name: build-output
            path: dist/

      # Artifacts saved to /tmp/act-artifacts/

  services:
    support: true
    description: Run service containers
    example: |
      services:
        postgres:
          image: postgres:15
          env:
            POSTGRES_PASSWORD: postgres

      # act starts service containers

---
## Compatibility

compatibility:
  github_actions:
    version: Compatible with GitHub Actions syntax
    features_supported:
      - Custom actions: yes
      - Reusable workflows: yes
      - Matrix builds: yes
      - Service containers: yes
      - Artifacts: yes
      - Caching: yes
      - Secrets: yes
      - Environment variables: yes

  docker:
    required_version: ">=20.10.0"
    images:
      - catthehacker/ubuntu:full-latest
      - catthehacker/ubuntu:runner-latest
      - catthehacker/ubuntu:act-latest

  operating_systems:
    - Ubuntu 25.10 (primary)
    - Ubuntu 24.04 LTS (tested)
    - Linux with Docker (should work)
